<%
// app/web/views/results/approve-results.ejs
// This template assumes your main layout already includes Bootstrap (or similar) + sidebar.
// Keep content-only (no <html> wrapper) to avoid breaking express-ejs-layouts.
const title = pageTitle || "Approve Result";
const roleLabel = role || "HOD";
const csrf = (typeof csrfToken !== "undefined" && csrfToken) ? csrfToken : (locals && locals.csrfToken ? locals.csrfToken : "");
%>

<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0"><%= title %></h2>
      <small class="text-muted">Review uploaded batches and approve/reject based on your role.</small>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Session</label>
          <select id="sessionId" class="form-select">
            <option value="ALL">All</option>
            <% (sessions || []).forEach(s => { %>
              <option value="<%= s.id %>">
                <%= s.name %><%= s.isCurrent ? " (Current)" : "" %>
              </option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Semester</label>
          <select id="semester" class="form-select">
            <option value="ALL">All</option>
            <option value="FIRST">First</option>
            <option value="SECOND">Second</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Level</label>
          <select id="level" class="form-select">
            <option value="ALL">All</option>
            <option value="ND1">ND1</option>
            <option value="ND2">ND2</option>
            <option value="HND1">HND1</option>
            <option value="HND2">HND2</option>
            <option value="100L">100L</option>
            <option value="200L">200L</option>
            <option value="300L">300L</option>
            <option value="400L">400L</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Course (optional)</label>
          <select id="courseId" class="form-select">
            <option value="ALL">All</option>
          </select>
          <small class="text-muted">Dropdown shows courses currently awaiting your approval.</small>
        </div>

        <div class="col-12">
          <label class="form-label">Status (optional override)</label>
          <input id="statusOverride" class="form-control" placeholder="Leave blank for your stage statuses" />
          <small class="text-muted">
            Example: UPLOADED, HOD_APPROVED, DEAN_APPROVED, BUSINESS_APPROVED, FINAL
          </small>
        </div>

        <div class="col-12 d-flex justify-content-end">
          <button id="btnApply" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <div class="alert alert-info">
    Your role: <b><%= roleLabel %></b> — Approve → next stage, Reject → reject stage.
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mb-0">
          <thead>
            <tr>
              <th style="width:60px">#</th>
              <th>Course</th>
              <th style="width:90px">Session</th>
              <th style="width:100px">Semester</th>
              <th style="width:90px">Level</th>
              <th style="width:90px">Batch</th>
              <th style="width:80px">Rows</th>
              <th style="width:120px">Status</th>
              <th style="width:170px">Uploaded At</th>
              <th style="width:220px">Action</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="text-center text-muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const csrfToken = <%- JSON.stringify(csrf || "") %>;

  const $ = (id) => document.getElementById(id);

  function q() {
    return {
      sessionId: $("sessionId").value,
      semester: $("semester").value,
      level: $("level").value,
      courseId: $("courseId").value,
      statusOverride: $("statusOverride").value.trim()
    };
  }

  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) {
      // Usually indicates CSRF block/redirect – show the first part of response for debugging
      const txt = await res.text();
      throw new Error(`Expected JSON but got: ${res.status}. ${txt.slice(0, 120)}`);
    }
    return res.json();
  }

  function buildQS(obj) {
    const p = new URLSearchParams();
    Object.keys(obj).forEach(k => {
      if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") p.set(k, obj[k]);
    });
    return p.toString();
  }

  async function loadCourses() {
    const { sessionId, semester, level } = q();
    const url = `/staff/results/approve/api/courses?` + buildQS({ sessionId, semester, level });
    const rows = await fetchJSON(url);
    const sel = $("courseId");
    const current = sel.value || "ALL";
    sel.innerHTML = `<option value="ALL">All</option>` + rows.map(r =>
      `<option value="${r.id}">${r.code} — ${r.title}</option>`
    ).join("");
    // try to keep selection
    sel.value = [...sel.options].some(o => o.value === current) ? current : "ALL";
  }

  function fmtDate(v) {
    if (!v) return "";
    try { return new Date(v).toLocaleString(); } catch { return String(v); }
  }

  async function loadBatches() {
    const { sessionId, semester, level, courseId } = q();
    const url = `/staff/results/approve/api/list?` + buildQS({ sessionId, semester, level, courseId });
    const rows = await fetchJSON(url);

    const tbody = $("tbody");
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">No records</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map((r, idx) => {
      const courseLabel = `${r.courseCode || ""} — ${r.courseTitle || ""}<div class="text-muted" style="font-size:12px">${r.schoolName || ""} / ${r.deptName || ""}</div>`;
      const batch = r.batch_id ?? "";
      const rowsCount = r.rows_in_results ?? 0;

      const viewUrl = `/staff/results/approve/view?batchId=${encodeURIComponent(r.id)}`;

      return `
        <tr>
          <td>${idx + 1}</td>
          <td>${courseLabel}</td>
          <td>${r.session_id ?? ""}</td>
          <td>${r.semester ?? ""}</td>
          <td>${r.level ?? ""}</td>
          <td>${batch}</td>
          <td>${rowsCount}</td>
          <td><span class="badge bg-secondary">${r.status ?? ""}</span></td>
          <td>${fmtDate(r.uploaded_at)}</td>
          <td>
            <a class="btn btn-sm btn-outline-dark me-2" target="_blank" href="${viewUrl}">View</a>
            <button class="btn btn-sm btn-success me-1" onclick="takeAction(${r.id}, 'approve')">Approve</button>
            <button class="btn btn-sm btn-danger" onclick="takeAction(${r.id}, 'reject')">Reject</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function takeAction(batchId, action) {
    const remark = prompt(`Enter remark (optional) for ${action.toUpperCase()}:`, "") || "";

    try {
      const payload = { batchId, action, remark };

      const data = await fetchJSON(`/staff/results/approve/api/action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // csurf accepts 'csrf-token' header by default
          "csrf-token": csrfToken
        },
        body: JSON.stringify(payload)
      });

      if (!data.ok) {
        alert(data.error || "Action failed");
        return;
      }

      await loadCourses();
      await loadBatches();
    } catch (e) {
      console.error(e);
      alert(String(e.message || e));
    }
  }

  $("btnApply").addEventListener("click", async () => {
    try {
      await loadCourses();
      await loadBatches();
    } catch (e) {
      console.error(e);
      alert(String(e.message || e));
    }
  });

  // initial load
  (async () => {
    try {
      await loadCourses();
      await loadBatches();
    } catch (e) {
      console.error(e);
      $("tbody").innerHTML = `<tr><td colspan="10" class="text-center text-danger">Failed to load. Check server logs.</td></tr>`;
    }
  })();
</script>
