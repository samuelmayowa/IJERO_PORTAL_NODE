<%
/* tolerant defaults */
const sess = (typeof currentSession !== 'undefined' && currentSession) ? currentSession : { name: 'Session' };
const paid = Number(typeof totalPaid !== 'undefined' ? totalPaid : 0);
const pa   = Number(typeof pendingActions !== 'undefined' ? pendingActions : 0);
const nt   = Number(typeof notices !== 'undefined' ? notices : 0);
const pb = (typeof paymentsBreakdown !== 'undefined' && paymentsBreakdown) ? paymentsBreakdown : { school:0, faculty:0, application:0 };
const recentApps = (typeof recentApplications !== 'undefined' && Array.isArray(recentApplications)) ? recentApplications : [];
const recentPays = (typeof recentPayments !== 'undefined' && Array.isArray(recentPayments)) ? recentPayments : [];
%>

<div class="row">
  <div class="col-12 col-sm-6 col-md-3">
    <div class="small-box bg-info">
      <div class="inner"><h3><%= sess.name %></h3><p>Current Admission Session</p></div>
      <div class="icon"><i class="fas fa-calendar"></i></div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-md-3">
    <div class="small-box bg-success">
      <div class="inner">
        <h3><%= paid.toLocaleString() %></h3>
        <p>Total Amount Paid</p>
        <p class="mb-0 text-sm">
          1. School: <%= Number(pb.school||0).toLocaleString() %><br/>
          2. Faculty Due: <%= Number(pb.faculty||0).toLocaleString() %><br/>
          3. Application Fee: <%= Number(pb.application||0).toLocaleString() %>
          &nbsp; <a href="/applicant/payments/history" class="text-dark"><strong>(View more)</strong></a>
        </p>
      </div>
      <div class="icon"><i class="fas fa-wallet"></i></div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-md-3">
    <div class="small-box bg-warning">
      <div class="inner"><h3><%= pa %></h3><p>Pending Actions</p></div>
      <div class="icon"><i class="fas fa-tasks"></i></div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-md-3">
    <div class="small-box bg-danger">
      <div class="inner"><h3><%= nt %></h3><p>Notices</p></div>
      <div class="icon"><i class="fas fa-bell"></i></div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Recent Application(s) -->
  <div class="col-lg-8">
    <div class="card card-success">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-file-signature mr-2"></i>Recent Application(s)</h3>
        <div class="card-tools">
          <a href="/applicant/application/return" class="btn btn-sm btn-outline-secondary">Return to Application</a>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
          <thead>
            <tr><th style="width:60px">#</th><th>Programme</th><th>Type</th><th>Status</th><th style="width:150px">Date</th></tr>
          </thead>
          <tbody>
            <% if (!recentApps.length) { %>
              <tr><td colspan="5" class="text-muted p-3">No recent applications.</td></tr>
            <% } else { recentApps.forEach((a,i)=>{ %>
              <tr>
                <td><%= i+1 %></td>
                <td><%= a.programme || '-' %></td>
                <td><%= a.type || '-' %></td>
                <td><span class="badge <%= a.status==='APPROVED'?'badge-success':(a.status==='PENDING'?'badge-warning':'badge-secondary') %>"><%= a.status || '-' %></span></td>
                <td><%= a.date || '-' %></td>
              </tr>
            <% }) } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Right column -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Announcements</h3></div>
      <div class="card-body">
        <p class="text-muted mb-0">Updates will appear here.</p>
      </div>
    </div>
  </div>
</div>

<!-- Recent Payment History -->
<div class="row">
  <div class="col-lg-12">
    <div class="card card-outline card-success">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-receipt mr-2"></i>Recent Payment History</h3>
        <div class="card-tools">
          <a href="/applicant/payments/history" class="btn btn-sm btn-outline-success">Open Full History</a>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
          <thead>
            <tr><th style="width:60px">#</th><th>RRR</th><th>Purpose</th><th>Amount</th><th>Status</th><th style="width:150px">Date</th></tr>
          </thead>
          <tbody>
            <% if (!recentPays.length) { %>
              <tr><td colspan="6" class="text-muted p-3">No recent payments.</td></tr>
            <% } else { recentPays.forEach((p,i)=>{ %>
              <tr>
                <td><%= i+1 %></td>
                <td><%= p.rrr || '-' %></td>
                <td><%= p.purpose || '-' %></td>
                <td><%= Number(p.amount||0).toLocaleString() %></td>
                <td><span class="badge <%= p.status==='PAID'?'badge-success':'badge-secondary' %>"><%= p.status || 'PENDING' %></span></td>
                <td><%= p.date || '-' %></td>
              </tr>
            <% }) } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
