<%
  const _sessions = (typeof sessions !== 'undefined' && sessions) ? sessions : [];
  const _semesters = (typeof semesters !== 'undefined' && semesters) ? semesters : [];
  const _schools = (typeof schools !== 'undefined' && schools) ? schools : [];
  const _batches = (typeof batches !== 'undefined' && batches) ? batches : [];
  const _pageError = (typeof pageError !== 'undefined' && pageError) ? pageError : '';
%>

<section class="content-header">
  <div class="container-fluid">
    <h1>Upload Student Result</h1>
    <% if (_pageError) { %>
      <div class="alert alert-danger mt-2"><%= _pageError %></div>
    <% } %>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <div id="alertBox" class="alert d-none"></div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Upload Result</strong>
        <a class="btn btn-outline-secondary btn-sm" id="downloadTemplateBtn" href="#">Download Upload Template</a>
      </div>

      <div class="card-body">
        <form id="uploadForm">
          <!-- CSRF token (we will also send it in header for multipart uploads) -->
          <input type="hidden" name="_csrf" id="_csrf" value="<%= csrfToken || '' %>">

          <div class="row">
            <div class="col-md-6">
              <label>Session</label>
              <select class="form-control" name="sessionId" id="sessionId" required>
                <option value="">-- Select Session --</option>
                <% _sessions.forEach(s => { %>
                  <option value="<%= s.id %>"><%= s.label %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-6">
              <label>Semester</label>
              <select class="form-control" name="semesterId" id="semesterId" required>
                <option value="">-- Select Semester --</option>
                <% _semesters.forEach(s => { %>
                  <option value="<%= s.id %>"><%= s.label %></option>
                <% }) %>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label>School</label>
              <select class="form-control" name="schoolId" id="schoolId">
                <option value="">-- Select School --</option>
                <% _schools.forEach(s => { %>
                  <option value="<%= s.id %>"><%= s.label %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-6">
              <label>Department</label>
              <select class="form-control" name="departmentId" id="departmentId">
                <option value="">-- Select Department --</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label>Programme</label>
              <select class="form-control" name="programmeId" id="programmeId">
                <option value="">-- Select Programme --</option>
              </select>
            </div>

            <div class="col-md-3">
              <label>Level</label>
              <select class="form-control" name="level" id="level">
                <option value="">-- Select Level --</option>
                <option value="ND1">ND1</option>
                <option value="ND2">ND2</option>
                <option value="HND1">HND1</option>
                <option value="HND2">HND2</option>
              </select>
              <small class="text-muted">Auto-fills from selected course.</small>
            </div>

            <div class="col-md-3">
              <label>Batch</label>
              <select class="form-control" name="batchId" id="batchId" required>
                <option value="">-- Select Batch --</option>
                <% _batches.forEach(b => { %>
                  <option value="<%= b.id %>"><%= b.label %></option>
                <% }) %>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <label>Assigned Course</label>
              <select class="form-control" name="courseId" id="courseId" required>
                <option value="">-- Select Course --</option>
              </select>
              <small class="text-muted">Only courses assigned to you (based on session & semester).</small>
            </div>
          </div>

          <div class="mt-3 p-3 bg-secondary text-white rounded d-flex justify-content-between align-items-center" id="selectedBar" style="display:none;">
            <div id="selectedText"></div>
            <a id="rejectionsLink" href="#" class="text-white font-weight-bold" style="display:none;">Download Rejections CSV</a>
          </div>

          <div class="row mt-4">
            <div class="col-md-8">
              <label>Select Excel/CSV File</label>
              <input class="form-control" type="file" name="file" id="file" accept=".xlsx,xls,csv" required />
            </div>
            <div class="col-md-4 d-flex align-items-end justify-content-between">
              <div>
                <label class="d-block">&nbsp;</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="overrideExisting" name="overrideExisting" />
                  <label class="form-check-label" for="overrideExisting">Override existing upload</label>
                </div>
              </div>
              <button class="btn btn-success" type="submit" id="uploadBtn">Upload Result</button>
            </div>
          </div>

          <hr class="mt-4" />
          <div class="text-muted">
            <strong>Accepted format:</strong>
            <div>S/N | MATRIC NO | FULL NAME | CA1 10% | CA2 10% | CA3 10% | EXAM SCORE 70% | REG_TYPE</div>
            <div>REG_TYPE allowed: MAIN, ELECTIVE, CARRYOVER</div>
            <div>You may include a title row above the header row â€” the system will auto-detect the header row.</div>
          </div>

        </form>
      </div>
    </div>

  </div>
</section>

<script>
  const BASE = window.location.pathname.replace(/\/$/, "");
  const el = (id) => document.getElementById(id);

  const alertBox = el("alertBox");
  const selectedBar = el("selectedBar");
  const selectedText = el("selectedText");
  const rejectionsLink = el("rejectionsLink");

  const sessionId = el("sessionId");
  const semesterId = el("semesterId");
  const schoolId = el("schoolId");
  const departmentId = el("departmentId");
  const programmeId = el("programmeId");
  const courseId = el("courseId");
  const level = el("level");

  const downloadTemplateBtn = el("downloadTemplateBtn");
  downloadTemplateBtn.href = `${BASE}/download-template`;

  function showAlert(type, msg) {
    alertBox.className = `alert alert-${type}`;
    alertBox.textContent = msg;
    alertBox.classList.remove("d-none");
  }

  function clearAlert() {
    alertBox.classList.add("d-none");
    alertBox.textContent = "";
  }

  function setSelectedBar(text, severity, rejectionUrl) {
    selectedBar.style.display = "flex";
    selectedText.textContent = text;

    selectedBar.classList.remove("bg-secondary", "bg-danger", "bg-warning", "bg-success", "text-dark");
    if (severity === "danger") selectedBar.classList.add("bg-danger");
    else if (severity === "warning") selectedBar.classList.add("bg-warning", "text-dark");
    else if (severity === "success") selectedBar.classList.add("bg-success");
    else selectedBar.classList.add("bg-secondary");

    if (rejectionUrl) {
      rejectionsLink.href = rejectionUrl;
      rejectionsLink.style.display = "inline";
    } else {
      rejectionsLink.style.display = "none";
    }
  }

  async function loadDepartments() {
    departmentId.innerHTML = `<option value="">-- Select Department --</option>`;
    programmeId.innerHTML = `<option value="">-- Select Programme --</option>`;
    if (!schoolId.value) return;

    const r = await fetch(`${BASE}/api/departments?schoolId=${encodeURIComponent(schoolId.value)}`, {
      credentials: "same-origin"
    });
    const j = await r.json().catch(() => ({}));
    if (!j.ok) return;

    j.items.forEach((d) => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.label;
      departmentId.appendChild(opt);
    });
  }

  async function loadProgrammes() {
    programmeId.innerHTML = `<option value="">-- Select Programme --</option>`;
    if (!departmentId.value) return;

    const r = await fetch(`${BASE}/api/programmes?departmentId=${encodeURIComponent(departmentId.value)}`, {
      credentials: "same-origin"
    });
    const j = await r.json().catch(() => ({}));
    if (!j.ok) return;

    j.items.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.label;
      programmeId.appendChild(opt);
    });
  }

  async function loadAssignedCourses() {
    courseId.innerHTML = `<option value="">-- Select Course --</option>`;
    selectedBar.style.display = "none";
    rejectionsLink.style.display = "none";

    if (!sessionId.value || !semesterId.value) return;

    const r = await fetch(
      `${BASE}/api/assigned-courses?sessionId=${encodeURIComponent(sessionId.value)}&semesterId=${encodeURIComponent(semesterId.value)}`,
      { credentials: "same-origin" }
    );
    const j = await r.json().catch(() => ({}));
    if (!j.ok) return;

    j.items.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.code} - ${c.title}`;
      opt.dataset.level = c.level || "";
      opt.dataset.units = c.units || "";
      courseId.appendChild(opt);
    });
  }

  function onCourseChange() {
    selectedBar.style.display = "none";
    rejectionsLink.style.display = "none";
    if (!courseId.value) return;

    const opt = courseId.options[courseId.selectedIndex];
    const lev = opt.dataset.level || "";
    const units = opt.dataset.units || "";
    if (lev) level.value = lev;

    setSelectedBar(
      `Selected: ${opt.textContent} | Unit: ${units || "-"} | Level: ${lev || "-"}`,
      "info",
      null
    );
  }

  schoolId.addEventListener("change", loadDepartments);
  departmentId.addEventListener("change", loadProgrammes);
  sessionId.addEventListener("change", loadAssignedCourses);
  semesterId.addEventListener("change", loadAssignedCourses);
  courseId.addEventListener("change", onCourseChange);

  el("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAlert();

    if (!sessionId.value || !semesterId.value || !courseId.value || !el("batchId").value) {
      showAlert("danger", "Please select Session, Semester, Batch and Assigned Course.");
      return;
    }

    const fd = new FormData(e.target);

    // IMPORTANT: for multipart uploads, send CSRF in header (csurf runs before multer)
    const csrfToken = el("_csrf")?.value || "";

    try {
      const r = await fetch(`${BASE}/api/upload`, {
        method: "POST",
        body: fd,
        credentials: "same-origin",
        headers: {
          "x-csrf-token": csrfToken
        }
      });

      let j = null;
      let rawText = "";
      try {
        j = await r.json();
      } catch (_) {
        rawText = await r.text().catch(() => "");
      }

      if (!r.ok) {
        const msg =
          (j && j.message) ||
          (rawText ? "Upload failed: Security token error. Please refresh and try again." : `Upload failed (HTTP ${r.status})`);
        showAlert("danger", msg);
        return;
      }

      const severity =
        j.severity ||
        (j.inserted > 0 ? (j.rejectedCount > 0 ? "warning" : "success") : "danger");

      showAlert(
        severity === "success" ? "success" : (severity === "warning" ? "warning" : "danger"),
        j.message || "Upload finished"
      );

      const opt = courseId.options[courseId.selectedIndex];
      const lev = level.value || opt.dataset.level || "-";
      const units = opt.dataset.units || "-";

      const rejUrl = j.hasRejections ? `${BASE}/api/rejections/${j.resultBatchId}.csv` : null;

      setSelectedBar(
        `Selected: ${opt.textContent} | Unit: ${units} | Level: ${lev}`,
        severity,
        rejUrl
      );
    } catch (err) {
      showAlert("danger", err.message || "Upload failed");
    }
  });

  loadAssignedCourses().catch(() => {});
</script>