<section class="content">
    <div class="container-fluid">

      <% if (messages && messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>

      <div class="card card-outline card-primary">
        <div class="card-header">
          <h3 class="card-title">Upload Result (per Course + Session + Semester + Level + Batch)</h3>
          <div class="card-tools">
            <a class="btn btn-sm btn-outline-secondary" href="/public/templates/lecturer_upload.xlsx" target="_blank">
              Download Upload Template
            </a>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label>Session</label>
              <select id="sessionId" class="form-control">
                <% sessions.forEach(s => { %>
                  <option value="<%= s.id %>" <%= (currentSession && currentSession.id === s.id) ? 'selected' : '' %>>
                    <%= s.name %> <%= s.is_current ? '(Current)' : '' %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-3">
              <label>Semester</label>
              <select id="semesterId" class="form-control">
                <% semesters.forEach(s => { %>
                  <option value="<%= s.id %>" <%= (currentSemester && currentSemester.id === s.id) ? 'selected' : '' %>>
                    <%= s.name %> <%= s.is_current ? '(Current)' : '' %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-3">
              <label>School</label>
              <select id="schoolId" class="form-control">
                <option value="">-- Select School --</option>
                <% schools.forEach(s => { %>
                  <option value="<%= s.id %>"><%= s.name %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-3">
              <label>Department</label>
              <select id="departmentId" class="form-control">
                <option value="">-- Select Department --</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-4">
              <label>Programme</label>
              <select id="programmeId" class="form-control">
                <option value="">-- Select Programme --</option>
              </select>
            </div>

            <div class="col-md-2">
              <label>Level</label>
              <select id="level" class="form-control">
                <option value="">-- Select Level --</option>
                <% (levels || []).forEach(l => { %>
                  <option value="<%= l %>"><%= l %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-2">
              <label>Batch</label>
              <select id="batchId" class="form-control">
                <option value="">-- Select Batch --</option>
                <% batches.forEach(b => { %>
                  <option value="<%= b.id %>"><%= b.code %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-4">
              <label>Course Code</label>
              <div class="input-group">
                <input id="courseCode" class="form-control" placeholder="e.g. GST101" />
                <div class="input-group-append">
                  <button id="btnFetch" class="btn btn-info" type="button">
                    <i class="fas fa-search"></i> Fetch & Validate
                  </button>
                </div>
              </div>
              <small class="text-muted">Only assigned lecturers can upload for a course.</small>
            </div>
          </div>

          <hr/>

          <div id="courseInfo" class="alert alert-secondary d-none"></div>

          <div id="uploadArea" class="d-none">
            <div class="row">
              <div class="col-md-6">
                <label>Select Excel/CSV File</label>
                <input id="file" type="file" class="form-control" accept=".xlsx,.xls,.csv" />
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <button id="btnUpload" class="btn btn-success btn-block" type="button">
                  <i class="fas fa-upload"></i> Upload Result
                </button>
              </div>
            </div>

            <div class="mt-3" id="uploadMsg"></div>
          </div>

        </div>
      </div>

    </div>
  </section>
</div>

<script>
  const DEPARTMENTS = <%- JSON.stringify(departments || []) %>;
  const PROGRAMMES  = <%- JSON.stringify(programmes || []) %>;
  const csrfToken = "<%= (csrfToken || '') %>";

  const elSchool = document.getElementById('schoolId');
  const elDept   = document.getElementById('departmentId');
  const elProg   = document.getElementById('programmeId');

  function fillDepartments() {
    const sid = elSchool.value;
    elDept.innerHTML = '<option value="">-- Select Department --</option>';
    elProg.innerHTML = '<option value="">-- Select Programme --</option>';

    const list = DEPARTMENTS.filter(d => String(d.school_id) === String(sid));
    list.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      elDept.appendChild(opt);
    });
  }

  function fillProgrammes() {
    const sid = elSchool.value;
    const did = elDept.value;
    elProg.innerHTML = '<option value="">-- Select Programme --</option>';

    const list = PROGRAMMES.filter(p =>
      String(p.school_id) === String(sid) &&
      String(p.department_id) === String(did)
    );

    list.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      elProg.appendChild(opt);
    });
  }

  elSchool.addEventListener('change', fillDepartments);
  elDept.addEventListener('change', fillProgrammes);

  const courseInfo = document.getElementById('courseInfo');
  const uploadArea = document.getElementById('uploadArea');
  const uploadMsg  = document.getElementById('uploadMsg');

  let validatedCourse = null;

  document.getElementById('btnFetch').addEventListener('click', async () => {
    uploadMsg.innerHTML = '';
    uploadArea.classList.add('d-none');
    courseInfo.classList.add('d-none');
    validatedCourse = null;

    const sessionId  = document.getElementById('sessionId').value;
    const semesterId = document.getElementById('semesterId').value;
    const code       = document.getElementById('courseCode').value.trim();

    if (!sessionId || !semesterId || !code) {
      alert('Select session, semester and enter course code.');
      return;
    }

    const url = `/staff/results/upload/api/course?code=${encodeURIComponent(code)}&sessionId=${encodeURIComponent(sessionId)}&semesterId=${encodeURIComponent(semesterId)}`;
    const r = await fetch(url);
    const j = await r.json();

    if (!j.ok) {
      courseInfo.classList.remove('d-none');
      courseInfo.classList.remove('alert-secondary');
      courseInfo.classList.add('alert-danger');
      courseInfo.textContent = j.message || 'Course validation failed';
      return;
    }

    validatedCourse = j.course;

    courseInfo.classList.remove('d-none');
    courseInfo.classList.remove('alert-danger');
    courseInfo.classList.add('alert-secondary');
    courseInfo.innerHTML = `<b>Validated:</b> ${j.course.code} â€” ${j.course.title} (${j.course.units || 0} units)`;

    uploadArea.classList.remove('d-none');
  });

  async function doUpload(override = 0) {
    const sessionId  = document.getElementById('sessionId').value;
    const semesterId = document.getElementById('semesterId').value;
    const schoolId   = document.getElementById('schoolId').value;
    const departmentId = document.getElementById('departmentId').value;
    const programmeId  = document.getElementById('programmeId').value;
    const level      = document.getElementById('level').value;
    const batchId    = document.getElementById('batchId').value;
    const courseCode = document.getElementById('courseCode').value.trim();
    const fileEl     = document.getElementById('file');

    if (!validatedCourse) return alert('Please Fetch & Validate course first.');
    if (!level || !batchId) return alert('Select level and batch.');
    if (!fileEl.files || !fileEl.files[0]) return alert('Select a file.');

    const fd = new FormData();
    fd.append('_csrf', csrfToken);
    fd.append('sessionId', sessionId);
    fd.append('semesterId', semesterId);
    fd.append('schoolId', schoolId);
    fd.append('departmentId', departmentId);
    fd.append('programmeId', programmeId);
    fd.append('level', level);
    fd.append('batchId', batchId);
    fd.append('courseCode', courseCode);
    fd.append('override', String(override));
    fd.append('file', fileEl.files[0]);

    uploadMsg.innerHTML = `<div class="alert alert-info">Uploading... please wait</div>`;

    const r = await fetch('/staff/results/upload/api/upload', { method: 'POST', body: fd });
    const j = await r.json();

    if (!j.ok && j.code === 'exists') {
      const yes = confirm(j.message || 'Result exists. Override?');
      if (yes) return doUpload(1);

      uploadMsg.innerHTML = `<div class="alert alert-warning">Upload cancelled.</div>`;
      return;
    }

    if (!j.ok) {
      uploadMsg.innerHTML = `<div class="alert alert-danger">${j.message || 'Upload failed'}</div>`;
      return;
    }

    let html = `<div class="alert alert-success">
      <b>Upload Completed</b><br/>
      Uploaded: <b>${j.uploaded}</b><br/>
      Rejected: <b>${j.rejected}</b>
    </div>`;

    if (j.rejectedDownload) {
      html += `<a class="btn btn-sm btn-outline-danger" href="${j.rejectedDownload}" target="_blank">
        Download Rejected Rows (CSV)
      </a>`;
    }
    uploadMsg.innerHTML = html;
  }

  document.getElementById('btnUpload').addEventListener('click', () => doUpload(0));
</script>
