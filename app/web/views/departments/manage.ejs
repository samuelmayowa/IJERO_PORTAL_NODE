<!-- app/web/views/departments/manage.ejs -->
<section class="content-header">
  <h1><%= pageTitle %></h1>
</section>

<section class="content">

  <% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>
  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <div class="alert alert-warning" style="border-left:4px solid #ffc107">
    <strong>Warning:</strong> Fields use interactive update. Be careful with accidental edits.
  </div>

  <!-- Add Department -->
  <div class="card card-outline card-primary">
    <div class="card-header"><h3 class="card-title">Add Department</h3></div>
    <form method="post" action="/staff/departments/create">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="card-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Name</label>
            <input name="name" class="form-control" placeholder="Department name" required>
          </div>
          <div class="form-group col-md-6">
            <label>School</label>
            <select name="school_id" id="dept-school" class="form-control" required>
              <option value="">-- select school --</option>
              <% (schools||[]).forEach(s => { %>
                <option value="<%= s.id %>"><%= s.name %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <button class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>

  <!-- Add Programme (associated with Dept) -->
  <div class="card card-outline card-success">
    <div class="card-header"><h3 class="card-title">Add Programme</h3></div>
    <form method="post" action="/staff/departments/programmes/create">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="card-body">
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>School</label>
            <select name="school_id" id="prog-school" class="form-control" required>
              <option value="">-- select school --</option>
              <% (schools||[]).forEach(s => { %>
                <option value="<%= s.id %>"><%= s.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group col-md-5">
            <label>Department</label>
            <select name="department_id" id="prog-dept" class="form-control" required>
              <option value="">-- select department --</option>
              <% (departments||[]).forEach(d => { %>
                <option value="<%= d.id %>" data-school="<%= d.school_id %>"><%= d.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label>Programme Name</label>
            <input name="programme_name" class="form-control" placeholder="e.g., Environmental Health Technology" required>
          </div>
        </div>
        <button class="btn btn-success">Save Programme</button>
      </div>
    </form>
  </div>

  <!-- Existing Departments -->
  <div class="card card-outline card-secondary">
    <div class="card-header d-flex align-items-center">
      <h3 class="card-title">Existing Departments</h3>
      <form class="form-inline ml-auto" method="get" action="/staff/departments">
        <input name="q" class="form-control form-control-sm mr-2" placeholder="Search dept / schoolâ€¦" value="<%= q || '' %>">
        <button class="btn btn-sm btn-outline-secondary">Search</button>
      </form>
    </div>

    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Department</th>
            <th>School</th>
            <th style="width:220px">Action</th>
          </tr>
        </thead>
        <tbody>
          <% if (!departments || !departments.length) { %>
            <tr><td colspan="4" class="text-center text-muted p-4">No records.</td></tr>
          <% } else { departments.forEach((d,i) => { %>
            <tr>
              <td><%= (page-1)*pageSize + i + 1 %></td>
              <td>
                <form class="form-inline" method="post" action="/staff/departments/<%= d.id %>/update">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input name="name" class="form-control" value="<%= d.name %>" style="min-width:280px">
                  <select name="school_id" class="form-control ml-2" style="min-width:260px">
                    <% (schools||[]).forEach(s => { %>
                      <option value="<%= s.id %>" <%= s.id===d.school_id?'selected':'' %>><%= s.name %></option>
                    <% }) %>
                  </select>
                  <button class="btn btn-sm btn-primary ml-2">Update</button>
                </form>
              </td>
              <td><%= d.school_name %></td>
              <td class="text-right pr-3">
                <form method="post" action="/staff/departments/<%= d.id %>/delete" onsubmit="return confirm('Delete this department?');" class="d-inline">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button class="btn btn-sm btn-danger">Delete</button>
                </form>
              </td>
            </tr>
          <% }) } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Programmes List -->
  <div class="card card-outline card-info">
    <div class="card-header"><h3 class="card-title">Existing Programmes</h3></div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Programme</th>
            <th>Department</th>
            <th>School</th>
            <th style="width:140px">Action</th>
          </tr>
        </thead>
        <tbody>
          <% var n = 0; %>
          <% if (!(programmes||[]).length) { %>
            <tr><td colspan="5" class="text-center text-muted p-4">No programmes yet.</td></tr>
          <% } else { %>
            <% programmes.forEach(p => { 
                 const dept = (departments||[]).find(d => d.id === p.department_id);
                 const sch  = (schools||[]).find(s => s.id === p.school_id);
                 n++;
            %>
              <tr>
                <td><%= n %></td>
                <td><%= p.name %></td>
                <td><%= dept ? dept.name : '' %></td>
                <td><%= sch ? sch.name : '' %></td>
                <td class="text-right pr-3">
                  <form method="post" action="/staff/departments/programmes/<%= p.id %>/delete" onsubmit="return confirm('Delete this programme?');" class="d-inline">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  // Filter dept list by selected school for Programme add form
  (function(){
    function filterDept(select, schoolId){
      const opts = Array.from(select.options);
      opts.forEach(o=>{
        if (!o.value) return;
        const s = o.getAttribute('data-school');
        o.style.display = (schoolId && s !== String(schoolId)) ? 'none' : '';
      });
      if (select.options[select.selectedIndex] && select.options[select.selectedIndex].style.display==='none'){
        select.value = '';
      }
    }
    const progSchool = document.getElementById('prog-school');
    const progDept   = document.getElementById('prog-dept');
    if (progSchool && progDept){
      progSchool.addEventListener('change', e => filterDept(progDept, e.target.value));
      filterDept(progDept, progSchool.value);
    }
  })();
</script>
