<!DOCTYPE html>
<html lang="en">
<head>
  <% /* helper for optional vars (not used for head/scripts) */ %>
  <% const safe = v => (typeof v !== 'undefined' && v) ? v : ''; %>

  <meta charset="utf-8" />
  <title><%= (typeof title !== 'undefined' && title) ? title : 'Dashboard' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- AdminLTE 3.2 + deps (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.4/main.min.css">

  <style>
    .brand-text { font-weight: 600; }
    .small-box .icon { opacity: .25; }
    .direct-chat-messages, .direct-chat-contacts { height: 300px; }
  </style>

  <!-- safe optional head injection -->
  <%- (typeof locals !== 'undefined' && typeof locals.head !== 'undefined' && locals.head) ? locals.head : '' %>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
      <li class="nav-item d-none d-sm-inline-block"><a href="/" class="nav-link">Home</a></li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a class="nav-link" data-widget="fullscreen" href="#"><i class="fas fa-expand-arrows-alt"></i></a></li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="/staff/dashboard" class="brand-link">
      <img src="/public/img/logo.png" class="brand-image img-circle elevation-3" style="opacity:.9" alt="Logo">
      <span class="brand-text">Admin E-Portal</span>
    </a>

    <div class="sidebar">
      <!-- User panel -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <!-- FIX: correct path -->
          <img src="/public/img/avatar.png" class="img-circle elevation-2" alt="User">
        </div>
        <div class="info">
          <a href="#" class="d-block"><%= (typeof user !== 'undefined' && user && user.name) ? user.name : 'User' %></a>
        </div>
      </div>

      <!-- FIX: render the sidebar partial here; remove stray </nav> -->
      <%- include('../partials/sidebar', {
        user: (typeof user !== 'undefined' && user)
                ? user
                : ((typeof locals !== 'undefined' && locals.user) ? locals.user : null)
      }) %>

    </div>
  </aside>

  <!-- Content -->
  <div class="content-wrapper">
    <% if (typeof readOnly !== 'undefined' && readOnly) { %>
  <div class="alert alert-warning mx-3 mt-3">
    <strong>Read-only mode:</strong>
    Your current status (<%= (user && user.status) ? user.status : 'READ-ONLY' %>) limits actions.
    Editing and administrative operations are disabled where applicable.
  </div>
<% } %>
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2 align-items-center">
        <div class="col-sm-6">
          <h1><%= (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : 'Dashboard' %></h1>
        </div>
        <div class="col-sm-6 text-right">
          <% const _displayName = (user && (user.username || user.name)) ? (user.username || user.name) : 'User'; %>
          <span class="mr-3">Welcome: <%= _displayName %></span>

          <!-- POST /logout needs CSRF -->
          <form id="logout-form" action="/logout" method="POST" class="d-inline">
            <input type="hidden" name="_csrf" value="<%= (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '' %>">
            <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#logoutConfirmModal">
              Logout
            </button>
          </form>

        </div>
      </div>
    </div>
  </section>

  <section class="content">
    <div class="container-fluid"><%- body %></div>
  </section>
</div>


  <footer class="main-footer"><strong>&copy; <%= new Date().getFullYear() %> Portal.</strong> All rights reserved.</footer>
  <aside class="control-sidebar control-sidebar-dark"></aside>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.4/main.min.js"></script>

<!-- safe optional scripts injection -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  var btn = document.getElementById('logout-btn');
  if (!btn) return;
  btn.addEventListener('click', function () {
    if (confirm('Are you sure you want to logout?')) {
      document.getElementById('logout-form').submit();
    }
  });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var confirmBtn = document.getElementById('confirm-logout');
    if (!confirmBtn) return;
    confirmBtn.addEventListener('click', function () {
      document.getElementById('logout-form').submit();
    });
  });
</script>


<%- (typeof locals !== 'undefined' && typeof locals.scripts !== 'undefined' && locals.scripts) ? locals.scripts : '' %>
<!-- Logout Confirm Modal -->
<div class="modal fade" id="logoutConfirmModal" tabindex="-1" role="dialog" aria-labelledby="logoutConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white py-2">
        <h5 class="modal-title" id="logoutConfirmLabel">Confirm Logout</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to logout?
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">No, Stay Logged In</button>
        <button type="button" id="confirm-logout" class="btn btn-danger btn-sm">Yes, Logout</button>
      </div>
    </div>
  </div>
</div>
  <!-- Global modal container + helper (available on every page) -->
  <%- include('../partials/modals') %>
  <script src="/public/js/modal.js"></script>
  <!-- Optional CSS for header close icon on colored bars -->
  <link rel="stylesheet" href="/public/css/app-modal.css">
</body>
</html>
