<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title><%= typeof title === 'string' ? title : 'Create Portal Account' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    :root{ --green:#247D57; --wine:#82103C; --ink:#222; }
    html,body{height:100%;}
    body{margin:0;color:var(--ink);}
    .page-container{position:relative; min-height:100vh; overflow:hidden;}
    .bg-cover{position:absolute; inset:0; background:url('/public/img/login-bg.jpg') center/cover no-repeat;}
    .bg-frost{position:absolute; inset:0; background:#fff; opacity:.85;}
    .card-wrap{position:relative; z-index:2; max-width:920px; margin:5vh auto; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.10); overflow:hidden; background:#fff;}
    .brand{display:flex; align-items:center; justify-content:space-between; padding:.9rem 1rem; background:var(--green); color:#fff;}
    .brand img{height:38px;}
    .brand p{margin:0; font-weight:700; letter-spacing:.3px;}
    .content{ padding:1.1rem 1.25rem 1.6rem; }
    .notice{ background:#fff7e0; border:1px solid #ffe39c; border-radius:6px; padding:10px 12px; margin-bottom:16px }
    .form-row-grid{ display:grid; grid-template-columns: 1fr 1fr; grid-gap:14px; }
    @media (max-width:900px){ .form-row-grid{ grid-template-columns:1fr; } }
    .form-group label{ font-weight:600; margin-bottom:4px; }
    .btn-submit{ background:var(--wine); color:#fff; font-weight:700; }
    .btn-submit:hover{ filter:brightness(.95); color:#fff; }
    .btn-green{ background:var(--green); color:#fff; font-weight:700; }
    .strength{height:8px; border-radius:4px; background:#eee; overflow:hidden;}
    .strength > div{height:100%;}
    .preview{ background:#f5f7fa; border:1px dashed #ccd; padding:12px; border-radius:8px; }
    .muted{color:#6b7280}
    .small-link{font-size:.9rem}

    /* simple modal for register errors */
    .simple-modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .simple-modal.active {
      display: flex;
    }
    .simple-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.45);
    }
    .simple-modal-dialog {
      position: relative;
      background: #ffffff;
      padding: 16px 18px;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      max-width: 420px;
      width: 90%;
    }
    .simple-modal-dialog h5 {
      margin-top: 0;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .form-control[readonly],
    .form-control.disabled-like {
      background:#f5f5f5;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
<div class="page-container">
  <div class="bg-cover"></div>
  <div class="bg-frost"></div>

  <div class="card-wrap">
    <div class="brand">
      <a href="/"><img src="/public/img/logo.png" alt="logo"></a>
      <p><i class="fa fa-user-plus"></i> SIGN-UP</p>
    </div>

    <div class="content">
      <% if (messages && messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>

      <div class="notice">
        <b>Note:</b> This registration only creates portal access. Complete applications or student actions after sign-in (payments, course registration, etc).
      </div>

      <form id="regForm" method="post" action="/register" novalidate>
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <input type="hidden" name="_preview" id="_preview" value="0" />

        <!-- student specific hidden helpers -->
        <input type="hidden" id="student_id" name="student_id" value="">
        <input type="hidden" id="student_verified" name="student_verified" value="0">
        <input type="hidden" id="orig_dob" name="orig_dob" value="">
        <input type="hidden" id="orig_phone" name="orig_phone" value="">

        <div class="form-row-grid">
          <div class="form-group">
            <label>Registering As</label>
            <select id="role" name="role" class="form-control" required>
              <option value="">-- choose --</option>
              <option value="applicant">Applicant</option>
              <option value="student">Student</option>
            </select>
            <small class="muted">Student requires a valid Access Code.</small>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>Date of Birth</label>
            <input id="dob" type="date" name="dob" class="form-control" required>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>First Name</label>
            <input name="first_name" class="form-control" required>
          </div>
          <div class="form-group" data-student-step="after-lookup">
            <label>Middle Name (optional)</label>
            <input name="middle_name" class="form-control">
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>Surname</label>
            <input name="last_name" class="form-control" required>
          </div>
          <div class="form-group" data-student-step="after-lookup">
            <label>Phone</label>
            <input id="phone" name="phone" class="form-control" required>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>State of Origin</label>
            <select id="state" name="state_of_origin" class="form-control" required></select>
          </div>
          <div class="form-group" data-student-step="after-lookup">
            <label>Local Government (LGA)</label>
            <select id="lga" name="lga" class="form-control" required></select>
          </div>

          <div class="form-group" data-student-step="lookup">
            <label>Email</label>
            <input id="email" type="email" name="email" class="form-control" placeholder="name@example.com" required>
            <small class="muted">We’ll use this as your portal username.</small>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>Username</label>
            <div class="input-group">
              <input id="username" name="username" class="form-control" readonly>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="editUsername">Edit</button>
              </div>
            </div>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>Matriculation Number</label>
            <input id="matric_number" name="matric_number" class="form-control" readonly>
          </div>

          <div class="form-group" id="accessWrap" data-student-step="lookup" style="display:none">
            <label>Access Code (Student)</label>
            <input id="access_code" name="access_code" maxlength="32" class="form-control" placeholder="16-character code">
            <small class="muted">Required only for Student registration.</small>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="verifyStudentBtn">
              Verify &amp; Load Details
            </button>
            <small id="lookupStatus" class="muted d-block mt-1"></small>
          </div>

          <div class="form-group" data-student-step="after-lookup">
            <label>Password</label>
            <div class="input-group">
              <input id="password" name="password" type="password" class="form-control" placeholder="Choose a strong password" required>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="togglePw"><i class="fa fa-eye"></i></button>
              </div>
            </div>
            <div class="strength mt-2"><div id="meter"></div></div>
            <small id="meterText" class="text-muted">Strength: —</small>
            <label class="form-check-label" for="terms">Password MUST be at least 8 characters long to proceed</label>
          </div>
        </div>

        <div class="form-group form-check mt-2">
          <input type="checkbox" class="form-check-input" id="terms" name="agree" value="1" required>
          <label class="form-check-label" for="terms">I accept the portal terms and conditions.</label>
        </div>

        <div class="d-flex mt-2">
          <button type="button" class="btn btn-secondary mr-2" id="previewBtn">Preview</button>
          <button class="btn btn-submit">Create account</button>
          <div class="ml-auto align-self-center small-link">
            Already have an account? <a href="/login" style="color:var(--wine); font-weight:700;">Login</a>
          </div>
        </div>

        <div id="previewBox" style="display:none; margin-top:16px">
          <div class="preview">
            <h5 class="mb-2"><i class="fa fa-eye"></i> Please confirm your details</h5>
            <div id="previewContent"></div>
            <div class="d-flex mt-2">
              <button class="btn btn-green mr-2" id="confirmSubmit" type="button">Submit Registration</button>
              <button class="btn btn-outline-secondary" id="editBtn" type="button">Edit</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- simple modal -->
  <div id="simpleModal" class="simple-modal">
    <div class="simple-modal-backdrop"></div>
    <div class="simple-modal-dialog">
      <h5><i class="fa fa-exclamation-circle"></i> Notice</h5>
      <p id="simpleModalMessage"></p>
      <button type="button" class="btn btn-success btn-sm" id="simpleModalClose">OK</button>
    </div>
  </div>
</div>

<script>
/* ===== Nigeria States & LGAs (full) ===== */
const NG_LGAS = {
  "Abia":["Aba North","Aba South","Arochukwu","Bende","Ikwuano","Isiala Ngwa North","Isiala Ngwa South","Isuikwuato","Obi Ngwa","Ohafia","Osisioma","Ugwunagbo","Ukwa East","Ukwa West","Umuahia North","Umuahia South","Umu Nneochi"],
  "Adamawa":["Demsa","Fufore","Ganye","Girei","Gombi","Guyuk","Hong","Jada","Lamurde","Madagali","Maiha","Mayo-Belwa","Michika","Mubi North","Mubi South","Numan","Shelleng","Song","Toungo","Yola North","Yola South"],
  "Akwa Ibom":["Abak","Eastern Obolo","Eket","Esit Eket","Essien Udim","Etim Ekpo","Etinan","Ibeno","Ibesikpo Asutan","Ibiono Ibom","Ika","Ikono","Ikot Abasi","Ikot Ekpene","Ini","Itu","Mbo","Mkpat Enin","Nsit Atai","Nsit Ibom","Nsit Ubium","Obot Akara","Okobo","Onna","Oron","Oruk Anam","Udung Uko","Ukanafun","Uruan","Urue-Offong/Oruko","Uyo"],
  "Anambra":["Aguata","Anambra East","Anambra West","Anaocha","Awka North","Awka South","Ayamelum","Dunukofia","Ekwusigo","Idemili North","Idemili South","Ihiala","Njikoka","Nnewi North","Nnewi South","Ogbaru","Onitsha North","Onitsha South","Orumba North","Orumba South","Oyi"],
  "Bauchi":["Alkaleri","Bauchi","Bogoro","Damban","Darazo","Dass","Gamawa","Ganjuwa","Giade","Itas/Gadau","Jama'are","Katagum","Kirfi","Misau","Ningi","Shira","Tafawa Balewa","Toro","Warji","Zaki"],
  "Bayelsa":["Brass","Ekeremor","Kolokuma/Opokuma","Nembe","Ogbia","Sagbama","Southern Ijaw","Yenagoa"],
  "Benue":["Ado","Agatu","Apa","Buruku","Gboko","Guma","Gwer East","Gwer West","Katsina-Ala","Konshisha","Kwande","Logo","Makurdi","Obi","Ogbadibo","Ohimini","Oju","Okpokwu","Otukpo","Tarka","Ukum","Ushongo","Vandeikya"],
  "Borno":["Abadam","Askira/Uba","Bama","Bayo","Biu","Chibok","Damboa","Dikwa","Gubio","Guzamala","Gwoza","Hawul","Jere","Kaga","Kala/Balge","Konduga","Kukawa","Kwaya Kusar","Mafa","Magumeri","Maiduguri","Marte","Mobbar","Monguno","Ngala","Nganzai","Shani"],
  "Cross River":["Abi","Akamkpa","Akpabuyo","Bakassi","Bekwarra","Biase","Boki","Calabar Municipal","Calabar South","Etung","Ikom","Obanliku","Obubra","Obudu","Odukpani","Ogoja","Yakurr","Yala"],
  "Delta":["Aniocha North","Aniocha South","Bomadi","Burutu","Ethiope East","Ethiope West","Ika North East","Ika South","Isoko North","Isoko South","Ndokwa East","Ndokwa West","Okpe","Oshimili North","Oshimili South","Patani","Sapele","Udu","Ughelli North","Ughelli South","Ukwuani","Uvwie","Warri North","Warri South","Warri South West"],
  "Ebonyi":["Abakaliki","Afikpo North","Afikpo South","Ebonyi","Ezza North","Ezza South","Ikwo","Ishielu","Ivo","Izzi","Ohaozara","Ohaukwu","Onicha"],
  "Edo":["Akoko-Edo","Egor","Esan Central","Esan North-East","Esan South-East","Esan West","Etsako Central","Etsako East","Etsako West","Igueben","Ikpoba-Okha","Orhionmwon","Oredo","Ovia North-East","Ovia South-West","Owan East","Owan West","Uhunmwonde"],
  "Ekiti":["Ado-Ekiti","Efon","Ekiti East","Ekiti South-West","Ekiti West","Emure","Gbonyin","Ido-Osi","Ijero","Ikere","Ikole","Ilejemeje","Irepodun/Ifelodun","Ise/Orun","Moba","Oye"],
  "Enugu":["Aninri","Awgu","Enugu East","Enugu North","Enugu South","Ezeagu","Igbo Etiti","Igbo Eze North","Igbo Eze South","Isi Uzo","Nkanu East","Nkanu West","Nsukka","Oji River","Udenu","Udi","Uzo-Uwani"],
  "FCT":["Abaji","Abuja Municipal","Bwari","Gwagwalada","Kuje","Kwali"],
  "Gombe":["Akko","Balanga","Billiri","Dukku","Funakaye","Gombe","Kaltungo","Kwami","Nafada","Shongom","Yamaltu/Deba"],
  "Imo":["Aboh Mbaise","Ahiazu Mbaise","Ehime Mbano","Ezinihitte","Ideato North","Ideato South","Ihitte/Uboma","Ikeduru","Isiala Mbano","Isu","Mbaitoli","Ngor Okpala","Njaba","Nkwerre","Nwangele","Obowo","Oguta","Ohaji/Egbema","Okigwe","Onuimo","Orlu","Orsu","Oru East","Oru West","Owerri Municipal","Owerri North","Owerri West"],
  "Jigawa":["Auyo","Babura","Biriniwa","Birnin Kudu","Buji","Dutse","Gagarawa","Garki","Gumel","Guri","Gwaram","Gwiwa","Hadejia","Jahun","Kafin Hausa","Kazaure","Kiri Kasama","Kiyawa","Maigatari","Malam Madori","Miga","Ringim","Roni","Sule Tankarkar","Taura","Yankwashi"],
  "Kaduna":["Birnin Gwari","Chikun","Giwa","Igabi","Ikara","Jaba","Jema'a","Kachia","Kaduna North","Kaduna South","Kagarko","Kajuru","Kaura","Kauru","Kubau","Kudan","Lere","Makarfi","Sabon Gari","Sanga","Soba","Zangon Kataf","Zaria"],
  "Kano":["Ajingi","Albasu","Bagwai","Bebeji","Bichi","Bunkure","Dala","Dambatta","Dawakin Kudu","Dawakin Tofa","Doguwa","Fagge","Gabasawa","Garko","Garun Mallam","Gaya","Gezawa","Gwale","Gwarzo","Kabo","Kano Municipal","Karaye","Kibiya","Kiru","Kumbotso","Kunchi","Kura","Madobi","Makoda","Minjibir","Nasarawa","Rano","Rimin Gado","Rogo","Shanono","Sumaila","Takai","Tarauni","Tofa","Tsanyawa","Tudun Wada","Ungogo","Warawa","Wudil"],
  "Katsina":["Bakori","Batagarawa","Batsari","Baure","Bindawa","Charanchi","Dandume","Danja","Dan Musa","Daura","Dutsi","Dutsin-Ma","Faskari","Funtua","Ingawa","Jibia","Kafur","Kaita","Kankara","Kankia","Katsina","Kurfi","Kusada","Mai'Adua","Malumfashi","Mani","Mashi","Matazu","Musawa","Rimi","Sabuwa","Safana","Sandamu","Zango"],
  "Kebbi":["Aleiro","Arewa Dandi","Argungu","Augie","Bagudo","Birnin Kebbi","Bunza","Dandi","Fakai","Gwandu","Jega","Kalgo","Koko/Besse","Maiyama","Ngaski","Sakaba","Shanga","Suru","Wasagu/Danko","Yauri","Zuru"],
  "Kogi":["Adavi","Ajaokuta","Ankpa","Bassa","Dekina","Ibaji","Idah","Igalamela-Odolu","Ijumu","Kabba/Bunu","Kogi","Lokoja","Mopa-Muro","Ofu","Ogori/Magongo","Okehi","Okene","Olamaboro","Omala","Yagba East","Yagba West"],
  "Kwara":["Asa","Baruten","Edu","Ekiti","Ifelodun","Ilorin East","Ilorin South","Ilorin West","Irepodun","Isin","Kaiama","Moro","Offa","Oke Ero","Oyun","Pategi"],
  "Lagos":["Agege","Ajeromi-Ifelodun","Alimosho","Amuwo-Odofin","Apapa","Badagry","Epe","Eti-Osa","Ibeju-Lekki","Ifako-Ijaiye","Ikeja","Ikorodu","Kosofe","Lagos Island","Lagos Mainland","Mushin","Ojo","Oshodi-Isolo","Shomolu","Surulere"],
  "Nasarawa":["Akwanga","Awe","Doma","Karu","Keana","Keffi","Kokona","Lafia","Nasarawa","Nasarawa Egon","Obi","Toto","Wamba"],
  "Niger":["Agaie","Agwara","Bida","Borgu","Bosso","Chanchaga","Edati","Gbako","Gurara","Katcha","Kontagora","Lapai","Lavun","Magama","Mariga","Mashegu","Mokwa","Muya","Paikoro","Rafi","Rijau","Shiroro","Suleja","Tafa","Wushishi"],
  "Ogun":["Abeokuta North","Abeokuta South","Ado-Odo/Ota","Egbado North","Egbado South","Ewekoro","Ifo","Ijebu East","Ijebu North","Ijebu North East","Ijebu Ode","Ikenne","Imeko Afon","Ipokia","Obafemi Owode","Odeda","Odogbolu","Ogun Waterside","Remo North","Shagamu"],
  "Ondo":["Akoko North-East","Akoko North-West","Akoko South-East","Akoko South-West","Akure North","Akure South","Ese Odo","Idanre","Ifedore","Ilaje","Ile Oluji/Okeigbo","Irele","Odigbo","Okitipupa","Ondo East","Ondo West","Ose","Owo"],
  "Osun":["Atakunmosa East","Atakunmosa West","Aiyedaade","Aiyedire","Boluwaduro","Boripe","Ede North","Ede South","Ife Central","Ife East","Ife North","Ife South","Egbedore","Ejigbo","Ila","Ilesa East","Ilesa West","Irepodun","Irewole","Isokan","Iwo","Obokun","Odo Otin","Ola Oluwa","Olorunda","Oriade","Orolu","Osogbo"],
  "Oyo":["Afijio","Akinyele","Atiba","Atisbo","Egbeda","Ibadan North","Ibadan North-East","Ibadan North-West","Ibadan South-East","Ibadan South-West","Ibarapa Central","Ibarapa East","Ibarapa North","Ido","Irepo","Iseyin","Itesiwaju","Iwajowa","Kajola","Lagelu","Ogbomosho North","Ogbomosho South","Ogo-Oluwa","Olorunsogo","Oluyole","Ona Ara","Orelope","Ori Ire","Oyo East","Oyo West","Saki East","Saki West","Surulere"],
  "Plateau":["Barkin Ladi","Bassa","Bokkos","Jos East","Jos North","Jos South","Kanam","Kanke","Langtang North","Langtang South","Mangu","Mikang","Pankshin","Qua'an Pan","Riyom","Shendam","Wase"],
  "Rivers":["Abua/Odual","Ahoada East","Ahoada West","Akuku-Toru","Andoni","Asari-Toru","Bonny","Degema","Eleme","Emohua","Etche","Gokana","Ikwerre","Khana","Obio/Akpor","Ogba/Egbema/Ndoni","Ogu/Bolo","Okrika","Omuma","Opobo/Nkoro","Oyigbo","Port Harcourt","Tai"],
  "Sokoto":["Binji","Bodinga","Dange Shuni","Gada","Goronyo","Gudu","Gwadabawa","Illela","Isa","Kebbe","Kware","Rabah","Sabon Birni","Shagari","Silame","Sokoto North","Sokoto South","Tambuwal","Tangaza","Tureta","Wamako","Wurno","Yabo"],
  "Taraba":["Ardo-Kola","Bali","Donga","Gashaka","Gassol","Ibi","Jalingo","Karim Lamido","Kumi","Lau","Sardauna","Takum","Ussa","Wukari","Yorro","Zing"],
  "Yobe":["Bade","Bursari","Damaturu","Fika","Fune","Geidam","Gujba","Gulani","Jakusko","Karasuwa","Machina","Nangere","Nguru","Potiskum","Tarmuwa","Yunusari","Yusufari"],
  "Zamfara":["Anka","Bakura","Birnin Magaji/Kiyaw","Bukkuyum","Bungudu","Gummi","Gusau","Kaura Namoda","Maradun","Maru","Shinkafi","Talata Mafara","Tsafe","Zurmi"]
};

document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('regForm');
  const roleSel = document.getElementById('role');
  const stateSel = document.getElementById('state');
  const lgaSel = document.getElementById('lga');
  const emailInput = document.getElementById('email');
  const usernameInput = document.getElementById('username');
  const editUsernameBtn = document.getElementById('editUsername');
  const accessWrap = document.getElementById('accessWrap');
  const accessInput = document.getElementById('access_code');
  const passwordInput = document.getElementById('password');
  const meterBar = document.getElementById('meter');
  const meterText = document.getElementById('meterText');
  const togglePwBtn = document.getElementById('togglePw');
  const previewBtn = document.getElementById('previewBtn');
  const confirmBtn = document.getElementById('confirmSubmit');
  const editBtn = document.getElementById('editBtn');
  const previewBox = document.getElementById('previewBox');
  const previewContent = document.getElementById('previewContent');
  const _previewInput = document.getElementById('_preview');
  const termsCheckbox = document.getElementById('terms');
  const studentIdInput = document.getElementById('student_id');
  const studentVerifiedInput = document.getElementById('student_verified');
  const origDobInput = document.getElementById('orig_dob');
  const origPhoneInput = document.getElementById('orig_phone');
  const dobInput = document.getElementById('dob');
  const phoneInput = document.getElementById('phone');
  const verifyStudentBtn = document.getElementById('verifyStudentBtn');
  const lookupStatus = document.getElementById('lookupStatus');
  const matricInput = document.getElementById('matric_number');

  const modal = document.getElementById('simpleModal');
  const modalMsg = document.getElementById('simpleModalMessage');
  const modalClose = document.getElementById('simpleModalClose');

  function showModal(msg) {
    if (!modal || !modalMsg) {
      alert(msg);
      return;
    }
    modalMsg.textContent = msg;
    modal.classList.add('active');
  }

  function hideModal() {
    if (modal) modal.classList.remove('active');
  }

  if (modalClose) {
    modalClose.addEventListener('click', hideModal);
    modal.addEventListener('click', function (e) {
      if (e.target === modal || e.target.classList.contains('simple-modal-backdrop')) {
        hideModal();
      }
    });
  }

  /* populate states + LGAs */
  if (stateSel && lgaSel) {
    const states = Object.keys(NG_LGAS).sort();
    stateSel.innerHTML =
      '<option value="">-- select state --</option>' +
      states.map(function (s) { return '<option>' + s + '</option>'; }).join('');

    function fillLgas(st) {
      const arr = NG_LGAS[st] || [];
      lgaSel.innerHTML =
        '<option value="">-- select LGA --</option>' +
        arr.map(function (n) { return '<option>' + n + '</option>'; }).join('');
    }

    stateSel.addEventListener('change', function (e) {
      fillLgas(e.target.value);
    });
  }

  /* email => username (readonly unless Edit) */
  function syncUsername() {
    if (!usernameInput) return;
    usernameInput.value = (emailInput.value || '').trim().toLowerCase();
  }
  if (emailInput && usernameInput) {
    emailInput.addEventListener('input', syncUsername);
    syncUsername();
  }

  if (editUsernameBtn && usernameInput) {
    editUsernameBtn.addEventListener('click', function () {
      if (roleSel.value === 'student' && studentVerifiedInput.value === '1') {
        // for verified students, username stays locked
        return;
      }
      usernameInput.readOnly = !usernameInput.readOnly;
      editUsernameBtn.textContent = usernameInput.readOnly ? 'Edit' : 'Lock';
    });
  }

  /* password strength + eye toggle */
  function scorePassword(s) {
    let n = 0;
    if (s.length >= 8) n++;
    if (/[A-Z]/.test(s)) n++;
    if (/[a-z]/.test(s)) n++;
    if (/[0-9]/.test(s)) n++;
    if (/[^A-Za-z0-9]/.test(s)) n++;
    return n;
  }
  function paintStrength() {
    const s = passwordInput.value || '';
    const n = scorePassword(s);
    const w = Math.min(100, (n / 5) * 100);
    meterBar.style.width = w + '%';
    meterBar.style.background = ['#ddd', '#f66', '#f90', '#cc3', '#6c6'][Math.min(n, 4)];
    meterText.textContent =
      'Strength: ' +
      (['—', 'Very Weak', 'Weak', 'Average', 'Good', 'Strong'][n] || '—');
  }
  if (passwordInput) {
    passwordInput.addEventListener('input', paintStrength);
  }
  if (togglePwBtn && passwordInput) {
    togglePwBtn.addEventListener('click', function () {
      const is = passwordInput.type === 'password';
      passwordInput.type = is ? 'text' : 'password';
      togglePwBtn.innerHTML =
        '<i class="fa ' + (is ? 'fa-eye-slash' : 'fa-eye') + '"></i>';
    });
  }

  let studentOriginalDob = '';
  let studentOriginalPhone = '';

  function refreshStudentVisibility() {
    const isStudent = roleSel.value === 'student';
    const isVerified = studentVerifiedInput.value === '1';

    var groups = document.querySelectorAll('[data-student-step]');
    groups.forEach(function (el) {
      const step = el.getAttribute('data-student-step');

      if (!isStudent) {
        // Applicant: show everything except the access-code block
        if (el.id === 'accessWrap') {
          el.style.display = 'none';
        } else {
          el.style.display = '';
        }
        return;
      }

      if (step === 'lookup') {
        if (el.id === 'accessWrap') {
          el.style.display = isVerified ? 'none' : '';
        } else {
          el.style.display = '';
        }
      } else if (step === 'after-lookup') {
        el.style.display = isVerified ? '' : 'none';
      } else {
        el.style.display = '';
      }
    });
  }

  function applyStudentLocks() {
    const isStudent = roleSel.value === 'student';
    const isVerified = studentVerifiedInput.value === '1';
    if (!isStudent || !isVerified) return;

    ['first_name', 'middle_name', 'last_name'].forEach(function (name) {
      const input = form.elements[name];
      if (input) {
        input.readOnly = true;
        input.classList.add('disabled-like');
      }
    });

    if (usernameInput) {
      usernameInput.readOnly = true;
      usernameInput.classList.add('disabled-like');
    }
    if (editUsernameBtn) {
      editUsernameBtn.disabled = true;
    }

    if (stateSel) {
      stateSel.disabled = true;
      stateSel.classList.add('disabled-like');
    }
    if (lgaSel) {
      lgaSel.disabled = true;
      lgaSel.classList.add('disabled-like');
    }
    if (matricInput) {
      matricInput.readOnly = true;
      matricInput.classList.add('disabled-like');
    }

    if (emailInput) {
      emailInput.readOnly = true;
      emailInput.classList.add('disabled-like');
    }
  }

  roleSel.addEventListener('change', function () {
    // reset student-specific state when switching away
    if (roleSel.value !== 'student') {
      studentIdInput.value = '';
      studentVerifiedInput.value = '0';
      studentOriginalDob = '';
      studentOriginalPhone = '';
      origDobInput.value = '';
      origPhoneInput.value = '';
      if (lookupStatus) lookupStatus.textContent = '';
      if (emailInput) {
        emailInput.readOnly = false;
        emailInput.classList.remove('disabled-like');
      }
      if (usernameInput) {
        usernameInput.readOnly = true;
        usernameInput.classList.remove('disabled-like');
      }
      if (editUsernameBtn) {
        editUsernameBtn.disabled = false;
        editUsernameBtn.textContent = 'Edit';
      }
      if (stateSel) stateSel.disabled = false;
      if (lgaSel) lgaSel.disabled = false;
    }
    refreshStudentVisibility();
  });

  refreshStudentVisibility();

  /* Verify & Load student details from /register/student-lookup */
  if (verifyStudentBtn) {
    verifyStudentBtn.addEventListener('click', async function () {
      if (roleSel.value !== 'student') {
        showModal('Student lookup is only for Student registrations.');
        return;
      }

      const emailVal = (emailInput.value || '').trim();
      const codeVal = (accessInput.value || '').trim();
      const csrfVal = form.querySelector('input[name="_csrf"]').value;

      if (!emailVal || !codeVal) {
        showModal('Please enter both Email and Access Code.');
        return;
      }

      try {
        if (lookupStatus) lookupStatus.textContent = 'Checking...';

        const resp = await fetch('/register/student-lookup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          },
          body: new URLSearchParams({
            email: emailVal,
            access_code: codeVal,
            _csrf: csrfVal,
          }).toString(),
        });

        const data = await resp.json();

        if (!data.ok) {
          studentVerifiedInput.value = '0';
          studentIdInput.value = '';
          if (lookupStatus) lookupStatus.textContent = '';
          showModal(
            data.message ||
              'Email and Access Code do not match any student record.'
          );
          refreshStudentVisibility();
          return;
        }

        const stu = data.student || {};

        if (form.elements['first_name'])
          form.elements['first_name'].value = stu.first_name || '';
        if (form.elements['middle_name'])
          form.elements['middle_name'].value = stu.middle_name || '';
        if (form.elements['last_name'])
          form.elements['last_name'].value = stu.last_name || '';

        if (usernameInput) {
          usernameInput.value = stu.email || emailVal;
        }
        if (matricInput) {
          matricInput.value = stu.matric_number || '';
        }

        if (emailInput) {
          emailInput.value = stu.email || emailVal;
          emailInput.readOnly = true;
          emailInput.classList.add('disabled-like');
        }

        // State / LGA
        if (stateSel && stu.state_of_origin) {
          stateSel.value = stu.state_of_origin;
          stateSel.dispatchEvent(new Event('change'));
        }
        if (lgaSel && stu.lga) {
          setTimeout(function () {
            lgaSel.value = stu.lga;
          }, 100);
        }

        if (dobInput) dobInput.value = stu.dob || '';
        if (phoneInput) phoneInput.value = stu.phone || '';

        studentOriginalDob = stu.dob || '';
        studentOriginalPhone = stu.phone || '';
        origDobInput.value = studentOriginalDob;
        origPhoneInput.value = studentOriginalPhone;

        studentIdInput.value = stu.id;
        studentVerifiedInput.value = '1';

        if (lookupStatus) {
          lookupStatus.textContent =
            'Student details loaded. Please update your Date of Birth, Phone and Password, then preview.';
        }

        refreshStudentVisibility();
        applyStudentLocks();
      } catch (err) {
        console.error('student lookup failed', err);
        studentVerifiedInput.value = '0';
        studentIdInput.value = '';
        if (lookupStatus) lookupStatus.textContent = '';
        showModal(
          'Could not verify your details at the moment. Please try again.'
        );
      }
    });
  }

  /* preview step */
  previewBtn.addEventListener('click', function () {
    const isStudent = roleSel.value === 'student';
    const isVerified = studentVerifiedInput.value === '1';

    if (isStudent && !isVerified) {
      showModal('Please verify your Email and Access Code first.');
      return;
    }

    if (isStudent) {
      const mustFix = [];
      const dobVal = (dobInput && dobInput.value || '').trim();
      const phoneVal = (phoneInput && phoneInput.value || '').trim();
      const pwdVal = (passwordInput && passwordInput.value || '').trim();

      if (!dobVal || dobVal === (studentOriginalDob || '').trim()) {
        mustFix.push('date of birth');
      }
      if (!phoneVal || phoneVal === (studentOriginalPhone || '').trim()) {
        mustFix.push('phone number');
      }
      if (!pwdVal || pwdVal.toLowerCase() === 'college1') {
        mustFix.push('password');
      }

      if (mustFix.length) {
        showModal(
          'You MUST update ' + mustFix.join(', ') + ' before you continue.'
        );
        return;
      }
    }

    // Normal browser validation (for visible fields)
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const fd = new FormData(form);
    const o = Object.fromEntries(fd.entries());
    const safe = function (k) {
      return (o[k] || '').toString();
    };

    const roleText = safe('role');
    const nameText =
      safe('first_name') +
      ' ' +
      safe('middle_name') +
      ' ' +
      safe('last_name');

    previewContent.innerHTML =
      '<ul class="mb-0" style="line-height:1.9">' +
      '<li><b>Registering As:</b> ' + roleText + '</li>' +
      '<li><b>Name:</b> ' + nameText + '</li>' +
      '<li><b>Date of Birth:</b> ' + safe('dob') + '</li>' +
      '<li><b>State/LGA:</b> ' + safe('state_of_origin') + ' / ' + safe('lga') + '</li>' +
      '<li><b>Phone:</b> ' + safe('phone') + '</li>' +
      '<li><b>Email/Username:</b> ' + safe('email') + '</li>' +
      (roleText === 'student'
        ? '<li><b>Matric Number:</b> ' + safe('matric_number') + '</li>'
        : '') +
      '</ul>';

    _previewInput.value = '1';
    previewBox.style.display = 'block';
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  });

  confirmBtn.addEventListener('click', function () {
    form.submit();
  });
  editBtn.addEventListener('click', function () {
    _previewInput.value = '0';
    previewBox.style.display = 'none';
  });
});
</script>
</body>
</html>
