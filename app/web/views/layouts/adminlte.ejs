<!DOCTYPE html>
<html lang="en">
<head>
  <% const safe = v => (typeof v !== 'undefined' && v) ? v : ''; %>

  <meta charset="utf-8" />
  <title><%= (typeof title !== 'undefined' && title) ? title : 'Dashboard' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- AdminLTE 3.2 + deps (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.4/main.min.css">

  <!-- Unified green (sidebar) + wine (active) skin -->
  <style>
    :root{
      /* GREEN */
      --sidebar-bg:#247D57;       /* main sidebar background */
      --sidebar-bg-dark:#1E6A4A;  /* brand strip */
      --sidebar-tree:#1F5F45;     /* treeview background */

      /* TEXT / HOVER */
      --sidebar-link:rgba(255,255,255,.9);
      --sidebar-link-muted:rgba(255,255,255,.75);
      --sidebar-hover:rgba(255,255,255,.08);

      /* WINE (active item) */
      --accent-wine:#82103C;
      --accent-wine-2:#9A1648;
    }

    .main-sidebar{ background:var(--sidebar-bg) !important; }
    .main-sidebar .brand-link{
      background:var(--sidebar-bg-dark) !important;
      border-bottom-color: rgba(255,255,255,.15) !important;
      color:#fff !important;
    }
    .main-sidebar .brand-link .brand-image{ filter:none; }

    .nav-sidebar .nav-link{ color:var(--sidebar-link-muted) !important; }
    .nav-sidebar .nav-link:hover{
      background-color:var(--sidebar-hover) !important; color:#fff !important;
    }

    .nav-sidebar .menu-open > .nav-link,
    .nav-sidebar .nav-link.active{
      background-color:var(--accent-wine) !important; color:#fff !important;
    }
    .nav-sidebar .menu-open > .nav-link:hover,
    .nav-sidebar .nav-link.active:hover{
      background-color:var(--accent-wine-2) !important;
    }

    .nav-sidebar .nav-icon{ color:var(--sidebar-link-muted) !important; }
    .nav-sidebar .nav-treeview{ background:var(--sidebar-tree) !important; }
    .nav-sidebar .nav-treeview > .nav-item > .nav-link{
      color:var(--sidebar-link-muted) !important;
    }
    .nav-sidebar .nav-treeview > .nav-item > .nav-link.active{
      background-color:var(--accent-wine) !important; color:#fff !important;
    }

    .brand-text { font-weight: 600; }
    .small-box .icon { opacity: .25; }
    .direct-chat-messages, .direct-chat-contacts { height: 300px; }
  </style>

  <!-- optional head injection -->
  <%- (typeof locals !== 'undefined' && typeof locals.head !== 'undefined' && locals.head) ? locals.head : '' %>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="/" class="nav-link">Home</a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#"><i class="fas fa-expand-arrows-alt"></i></a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- brand: go to role-aware home -->
    <a href="/dashboard" class="brand-link">
      <img src="/public/img/logo.png" class="brand-image img-circle elevation-3" style="opacity:.9" alt="Logo">
      <span class="brand-text">College Portal</span>
    </a>

    <div class="sidebar">
      <!-- User panel -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="/public/img/avatar.png" class="img-circle elevation-2" alt="User">
        </div>
        <div class="info">
          <% 
            // Build unified _user EARLY so we can display a proper name here as well.
            const __user =
              (typeof user !== 'undefined' && user && user) ? user :
              (typeof publicUser !== 'undefined' && publicUser && publicUser) ? publicUser :
              ((typeof locals !== 'undefined' && (locals.user || locals.publicUser)) ? (locals.user || locals.publicUser) : null);
            const __displayName =
              __user && (__user.first_name || __user.name || __user.username)
                ? (__user.first_name || __user.name || __user.username)
                : 'User';
          %>
          <a href="#" class="d-block"><%= __displayName %></a>
        </div>
      </div>

      <% 
        // ----- Resolve user & role safely (uses same __user) -----
        const _user = __user;

        // derive role (prefer explicit role, otherwise infer from path)
        const _path = (typeof currentPath === 'string') ? currentPath : '';
        let _role = (_user && _user.role ? String(_user.role) : '').toLowerCase();

        if (!_role) {
          if (_path.startsWith('/student'))    _role = 'student';
          else if (_path.startsWith('/applicant')) _role = 'applicant';
          else _role = 'staff';
        }


        // Normalize common aliases
        if (['administrator','superadmin'].includes(_role)) _role = 'admin';

        // Only allow known role partials; otherwise fall back to 'staff'
        const roleCandidates = [
          'admin','staff','lecturer','hod','dean','bursary','registry','admission officer','ict','student','applicant'
        ];
        const roleFile = roleCandidates.includes(_role) ? _role : 'staff';

        // Ensure currentPath & allowedModules always exist for partials
        const _currentPath = (typeof currentPath === 'string') ? currentPath : '';
        const _allowedModules = (typeof locals !== 'undefined' && typeof locals.allowedModules !== 'undefined')
          ? locals.allowedModules
          : null;
      %>

      <!-- Role-specific sidebar -->
      <%- include('../partials/sidebars/' + roleFile, {
        user: _user,
        currentPath: _currentPath,
        allowedModules: _allowedModules
      }) %>

    </div>
  </aside>

  <!-- Content -->
  <div class="content-wrapper">
    <% 
      // Build display name for the header (also uses __user so it works for public users)
      const _displayName =
        (__user && (__user.first_name || __user.name || __user.username))
          ? (__user.first_name || __user.name || __user.username)
          : 'User';
    %>

    <% if (typeof readOnly !== 'undefined' && readOnly) { %>
      <div class="alert alert-warning mx-3 mt-3">
        <strong>Read-only mode:</strong>
        Your current status (<%= (_user && _user.status) ? _user.status : 'READ-ONLY' %>) limits actions.
        Editing and administrative operations are disabled where applicable.
      </div>
    <% } %>

    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2 align-items-center">
          <div class="col-sm-6">
            <h1><%= (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : 'Dashboard' %></h1>
          </div>
          <div class="col-sm-6 text-right">
            <span class="mr-3">Welcome: <%= _displayName %></span>

            <!-- POST /logout needs CSRF; we will fall back to GET if token missing -->
            <form id="logout-form" action="/logout" method="POST" class="d-inline">
              <input type="hidden" name="_csrf" value="<%= (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '' %>">
              <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#logoutConfirmModal">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <%- body %>
      </div>
    </section>
  </div>

  <footer class="main-footer">
    <strong>&copy; <%= new Date().getFullYear() %> Portal.</strong> All rights reserved.
  </footer>
  <aside class="control-sidebar control-sidebar-dark"></aside>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.4/main.min.js"></script>

<!-- optional scripts injection -->
<%- (typeof locals !== 'undefined' && typeof locals.scripts !== 'undefined' && locals.scripts) ? locals.scripts : '' %>

<!-- Logout Confirm Modal -->
<div class="modal fade" id="logoutConfirmModal" tabindex="-1" role="dialog" aria-labelledby="logoutConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white py-2">
        <h5 class="modal-title" id="logoutConfirmLabel">Confirm Logout</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">Are you sure you want to logout?</div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">No, Stay Logged In</button>
        <button type="button" id="confirm-logout" class="btn btn-danger btn-sm">Yes, Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Global modal container + helper -->
<%- include('../partials/modals') %>
<script src="/public/js/modal.js"></script>
<link rel="stylesheet" href="/public/css/app-modal.css">

<script>
  // Reliable logout: prefer POST with CSRF; fall back to GET if token is not present
  document.addEventListener('DOMContentLoaded', function () {
    var confirmBtn = document.getElementById('confirm-logout');
    if (!confirmBtn) return;

    var tokenPresent = '<%= (typeof csrfToken !== "undefined" && csrfToken) ? "1" : "" %>' === '1';
    confirmBtn.addEventListener('click', function () {
      var form = document.getElementById('logout-form');
      if (tokenPresent && form) {
        form.submit();                 // POST /logout with CSRF token
      } else {
        window.location.href = '/logout'; // fallback GET /logout
      }
    });
  });
</script>

</body>
</html>
