<!-- app/web/views/courses/lecture-time.ejs -->

<section class="content-header">
  <h1><%= pageTitle %></h1>
</section>

<section class="content">

  <!-- SUCCESS -->
  <% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show">
      <strong><i class="fas fa-check-circle"></i> Success: </strong> <%= success %>
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
  <% } %>

  <!-- ERROR -->
  <% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show">
      <strong><i class="fas fa-exclamation-triangle"></i> Error: </strong> <%= error %>
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
  <% } %>

  <!-- ===================== SUMMARY CARDS ===================== -->
  <div class="row mb-3">

    <div class="col-md-4">
      <div class="small-box bg-info">
        <div class="inner">
          <h3><%= summary.total_assigned %></h3>
          <p>Total Courses Assigned to You</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="small-box bg-success">
        <div class="inner">
          <h3><%= summary.lecture_set %></h3>
          <p>Lecture Times Already Set</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3><%= summary.remaining %></h3>
          <p>Courses Without Lecture Time</p>
        </div>
      </div>
    </div>

  </div>

  <!-- ===================== SET LECTURE TIME FORM ===================== -->
  <div class="card card-primary mb-3">
    <div class="card-header">
      <h3 class="card-title">Set / Update Lecture Time</h3>
    </div>

    <form method="POST"
          action="/staff/lecture-time/save"
          onsubmit="return validateLectureForm();">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" name="assignment_id" id="assignment_id">

      <div class="card-body row">

        <!-- SESSION -->
        <div class="form-group col-md-3">
          <label>Academic Session</label>
          <select id="session_select" class="form-control">
            <% sessions.forEach(s => { %>
              <option value="<%= s.id %>"
                <%= String(selectedSessionId) === String(s.id) ? 'selected' : '' %>>
                <%= s.name %>
              </option>
            <% }) %>
          </select>
        </div>

        <!-- SEMESTER -->
        <div class="form-group col-md-3">
          <label>Semester</label>
          <select id="semester_select" class="form-control">
            <option value="FIRST"  <%= selectedSemester === 'FIRST' ? 'selected' : '' %>>First</option>
            <option value="SECOND" <%= selectedSemester === 'SECOND' ? 'selected' : '' %>>Second</option>
          </select>
        </div>

        <!-- COURSE SEARCH -->
        <div class="form-group col-md-6 position-relative">
          <label>Search Assigned Course</label>
          <input type="text"
                 id="course_search"
                 class="form-control"
                 placeholder="Type course code or title…"
                 autocomplete="off">

          <ul id="course_dropdown"
              class="dropdown-menu show"
              style="display:none; width:100%; max-height:220px; overflow-y:auto; position:absolute; top:100%; left:0; z-index:1050;">
          </ul>
        </div>

        <!-- LECTURE DATE -->
        <div class="form-group col-md-3">
          <label>Lecture Date</label>
          <input type="date"
                 class="form-control"
                 name="lecture_date"
                 id="lecture_date"
                 required>
        </div>

        <!-- START TIME -->
        <div class="form-group col-md-3">
          <label>Start Time</label>
          <input type="time"
                 class="form-control"
                 name="start_time"
                 id="start_time"
                 required>
        </div>

        <!-- END TIME -->
        <div class="form-group col-md-3">
          <label>End Time</label>
          <input type="time"
                 class="form-control"
                 name="end_time"
                 id="end_time"
                 required>
        </div>

        <!-- VENUE (now driven from lecture_venues.name) -->
        <div class="form-group col-md-3">
          <label>Venue</label>

          <% if (!lectureVenues || !lectureVenues.length) { %>
            <select class="form-control" id="venue" name="venue" disabled>
              <option value="">No venues defined</option>
            </select>
            <small class="form-text text-muted">
              Venues are managed under Attendance &raquo; Set Student Lecture Venue.
            </small>
          <% } else { %>
            <select class="form-control" id="venue" name="venue" required>
              <option value="">-- Select Venue --</option>
              <% lectureVenues.forEach(v => { %>
                <option value="<%= v.venue_name %>"><%= v.venue_name %></option>
              <% }) %>
            </select>
            <small class="form-text text-muted">
              Venues are managed under Attendance &raquo; Set Student Lecture Venue.
            </small>
          <% } %>
        </div>

        <!-- STUDENT DEPARTMENT -->
        <div class="form-group col-md-4">
          <label>Student Department for this Lecture</label>
          <select class="form-control"
                  name="student_department_id"
                  id="student_department_id">
            <option value="">-- Select Department --</option>
            <% departments.forEach(d => { %>
              <option value="<%= d.id %>"><%= d.name %></option>
            <% }) %>
          </select>
        </div>

      </div>

      <div class="card-footer">
        <button type="submit" class="btn btn-primary">
          Save Lecture Time
        </button>
      </div>
    </form>
  </div>

  <!-- ===================== EXISTING LECTURE TIMES TABLE ===================== -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="card-title">Your Lecture Times</h3>

      <form method="GET" class="form-inline">
        <input name="q"
               class="form-control form-control-sm mr-2"
               placeholder="Search by code, title, session…"
               value="<%= q %>">
        <button class="btn btn-sm btn-secondary">Search</button>
      </form>
    </div>

    <div class="card-body table-responsive p-0">
      <table class="table table-bordered table-striped mb-0">
        <thead>
          <tr>
            <th>Course Code</th>
            <th>Title</th>
            <th>Level</th>
            <th>Session</th>
            <th>Semester</th>
            <th>Date</th>
            <th>Time</th>
            <th>Venue</th>
            <th>Student Dept.</th>
          </tr>
        </thead>

        <tbody>
          <% if (!lectures.length) { %>
            <tr>
              <td colspan="9" class="text-center py-3">
                No lecture times found for your assigned courses.
              </td>
            </tr>
          <% } else { lectures.forEach(row => { %>
            <tr>
              <td><%= row.code %></td>
              <td><%= row.title %></td>
              <td><%= row.level %></td>
              <td><%= row.session_name %></td>
              <td><%= row.semester %></td>
              <td><%= row.lecture_date ? row.lecture_date.toISOString
                     ? row.lecture_date.toISOString().slice(0,10)
                     : row.lecture_date
                     : '' %></td>
              <td>
                <%= row.start_time ? row.start_time.toString().slice(0,5) : '' %>
                -
                <%= row.end_time ? row.end_time.toString().slice(0,5) : '' %>
              </td>
              <td><%= row.venue %></td>
              <td><%= row.student_department || '' %></td>
            </tr>
          <% }); } %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="card-footer text-center">
      <% const pages = Math.ceil(total / pageSize); %>
      <% if (pages > 1) { %>
        <ul class="pagination pagination-sm justify-content-center">
          <% for (let i = 1; i <= pages; i++) { %>
            <li class="page-item <%= page === i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&q=<%= q %>"><%= i %></a>
            </li>
          <% } %>
        </ul>
      <% } %>
    </div>
  </div>

</section>

<!-- ===================== RESET MODAL FOR ALREADY-SET COURSES ===================== -->
<div class="modal fade" id="resetLectureModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">

      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-circle"></i> Already Set
        </h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <p>
          You already set a lecture time for:
          <strong class="js-course-name"></strong>
        </p>
        <p>
          Current schedule:
          <strong class="js-current-schedule"></strong>
        </p>
        <p>
          Do you want to reset and save a new date, time and venue?
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary js-reset-no">No</button>
        <button type="button" class="btn btn-warning js-reset-yes">Yes, Reset</button>
      </div>

    </div>
  </div>
</div>

<!-- ===================== PAGE SCRIPTS ===================== -->
<script>
function validateLectureForm() {
  const assignmentId = document.getElementById('assignment_id').value.trim();
  if (!assignmentId) {
    alert('Please search and select one of your assigned courses first.');
    return false;
  }
  return true;
}

document.addEventListener('DOMContentLoaded', function () {
  const sessionSelect   = document.getElementById('session_select');
  const semesterSelect  = document.getElementById('semester_select');
  const courseInput     = document.getElementById('course_search');
  const dropdown        = document.getElementById('course_dropdown');
  const assignmentInput = document.getElementById('assignment_id');

  const dateInput       = document.getElementById('lecture_date');
  const startTimeInput  = document.getElementById('start_time');
  const endTimeInput    = document.getElementById('end_time');
  const venueInput      = document.getElementById('venue');
  const studentDept     = document.getElementById('student_department_id');

  const modalEl         = document.getElementById('resetLectureModal');
  const modalCourseName = modalEl.querySelector('.js-course-name');
  const modalSchedule   = modalEl.querySelector('.js-current-schedule');
  const modalBtnNo      = modalEl.querySelector('.js-reset-no');
  const modalBtnYes     = modalEl.querySelector('.js-reset-yes');

  let lastSelectedItem = null;

  function buildScheduleString(item) {
    const d  = item.lecture_date ? item.lecture_date.toString().slice(0, 10) : '';
    const st = item.start_time   ? item.start_time.toString().slice(0, 5)   : '';
    const et = item.end_time     ? item.end_time.toString().slice(0, 5)     : '';
    const v  = item.venue || '';
    if (!d && !st && !et && !v) return 'No details stored.';
    return d + ' ' + st + ' - ' + et + ' @ ' + v;
  }

  function clearForm() {
    assignmentInput.value = '';
    courseInput.value     = '';
    dateInput.value       = '';
    startTimeInput.value  = '';
    endTimeInput.value    = '';
    venueInput.value      = '';
    if (studentDept) studentDept.value = '';
  }

  function fetchCourses() {
    const q  = courseInput.value.trim();
    if (!q) {
      dropdown.style.display = 'none';
      assignmentInput.value = '';
      return;
    }

    const sessionId = sessionSelect.value;
    const semester  = semesterSelect.value;

    const url = `/staff/lecture-time/api/my-courses?session_id=${encodeURIComponent(sessionId)}&semester=${encodeURIComponent(semester)}&q=${encodeURIComponent(q)}`;

    fetch(url)
      .then(r => r.json())
      .then(d => {
        dropdown.innerHTML = '';

        if (!d.ok || !d.items || d.items.length === 0) {
          dropdown.innerHTML = '<li class="px-3 py-2 text-muted">No matching records</li>';
          dropdown.style.display = 'block';
          return;
        }

        d.items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'dropdown-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <span>${item.code} - ${item.title} (${item.level})</span>
          `;

          if (item.already_set) {
            li.classList.add('text-muted');
            const badge = document.createElement('span');
            badge.className = 'badge badge-secondary ml-2';
            badge.textContent = 'Already set';
            li.appendChild(badge);
          }

          li.addEventListener('click', function () {
            courseInput.value = `${item.code} - ${item.title} (${item.level})`;
            assignmentInput.value = item.assignment_id;
            dropdown.style.display = 'none';

            // Always pre-fill if already_set, otherwise clear
            if (item.already_set) {
              dateInput.value = item.lecture_date ? item.lecture_date.toString().slice(0, 10) : '';
              startTimeInput.value = item.start_time ? item.start_time.toString().slice(0, 5) : '';
              endTimeInput.value   = item.end_time   ? item.end_time.toString().slice(0, 5)   : '';
              venueInput.value     = item.venue || '';

              lastSelectedItem = item;

              // Show modal asking to reset
              modalCourseName.textContent = `${item.code} - ${item.title}`;
              modalSchedule.textContent = buildScheduleString(item);

              const modal = new bootstrap.Modal(modalEl);

              modalBtnNo.onclick = function () {
                // Cancel: clear selection & values
                clearForm();
                modal.hide();
              };

              modalBtnYes.onclick = function () {
                // Keep pre-filled values; user can adjust and submit
                modal.hide();
              };

              modal.show();
            } else {
              // New course with no lecture time yet
              dateInput.value = '';
              startTimeInput.value = '';
              endTimeInput.value = '';
              venueInput.value = '';
              if (studentDept) studentDept.value = '';
            }
          });

          dropdown.appendChild(li);
        });

        dropdown.style.display = 'block';
      })
      .catch(err => {
        console.error(err);
      });
  }

  courseInput.addEventListener('input', function () {
    if (!this.value.trim()) {
      dropdown.style.display = 'none';
      assignmentInput.value = '';
      return;
    }
    fetchCourses();
  });

  sessionSelect.addEventListener('change', function () {
    if (courseInput.value.trim()) {
      fetchCourses();
    }
  });

  semesterSelect.addEventListener('change', function () {
    if (courseInput.value.trim()) {
      fetchCourses();
    }
  });

  document.addEventListener('click', function (e) {
    if (!courseInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
});
</script>
