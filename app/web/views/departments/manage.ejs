<!-- app/web/views/departments/manage.ejs -->
<section class="content-header">
  <h1><%= pageTitle %></h1>
</section>

<section class="content">

  <% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>
  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <div class="alert alert-warning" style="border-left:4px solid #ffc107">
    <strong>Warning:</strong> Fields use interactive update. Be careful with accidental edits.
  </div>

  <div class="card card-outline card-primary">
    <div class="card-header"><h3 class="card-title">Add Department</h3></div>
    <form method="post" action="/staff/departments/create">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="card-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Name</label>
            <input name="name" class="form-control" placeholder="Department name" required>
          </div>
          <div class="form-group col-md-6">
            <label>School</label>
            <select name="school_id" class="form-control" required>
              <option value="">-- select school --</option>
              <% (schools||[]).forEach(s => { %>
                <option value="<%= s.id %>"><%= s.name %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <button class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>

  <div class="card card-outline card-secondary">
    <div class="card-header d-flex align-items-center">
      <h3 class="card-title">Existing Departments</h3>
      <form class="form-inline ml-auto" method="get" action="/staff/departments">
        <input name="q" class="form-control form-control-sm mr-2" placeholder="Search dept / schoolâ€¦" value="<%= q || '' %>">
        <button class="btn btn-sm btn-outline-secondary">Search</button>
      </form>
    </div>

    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr><th style="width:60px">#</th><th>Department</th><th>School</th><th style="width:180px">Action</th></tr>
        </thead>
        <tbody>
          <% if (!departments || !departments.length) { %>
            <tr><td colspan="4" class="text-center text-muted p-4">No records.</td></tr>
          <% } else { departments.forEach((d,i) => { %>
            <tr>
              <td><%= (page-1)*pageSize + i + 1 %></td>
              <td>
                <form class="form-inline" method="post" action="/staff/departments/<%= d.id %>/update">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input name="name" class="form-control" value="<%= d.name %>" style="min-width:280px">
                  <select name="school_id" class="form-control ml-2" style="min-width:260px">
                    <% (schools||[]).forEach(s => { %>
                      <option value="<%= s.id %>" <%= s.id===d.school_id?'selected':'' %>><%= s.name %></option>
                    <% }) %>
                  </select>
                  <button class="btn btn-sm btn-primary ml-2">Update</button>
                </form>
              </td>
              <td><%= d.school_name %></td>
              <td class="text-right pr-3">
                <form method="post" action="/staff/departments/<%= d.id %>/delete" onsubmit="return confirm('Delete this department?');">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button class="btn btn-sm btn-danger">Delete</button>
                </form>
              </td>
            </tr>
          <% }) } %>
        </tbody>
      </table>
    </div>

    <div class="card-footer text-center">
      <% const pages = Math.ceil((total||0) / pageSize); %>
      <% if (pages > 1) { %>
        <nav>
          <ul class="pagination justify-content-center">
            <li class="page-item <%= page===1?'disabled':'' %>">
              <a class="page-link" href="?q=<%= encodeURIComponent(q||'') %>&page=<%= page-1 %>">Prev</a>
            </li>
            <% for (let p=1; p<=pages; p++) { %>
              <li class="page-item <%= p===page?'active':'' %>">
                <a class="page-link" href="?q=<%= encodeURIComponent(q||'') %>&page=<%= p %>"><%= p %></a>
              </li>
            <% } %>
            <li class="page-item <%= page===pages?'disabled':'' %>">
              <a class="page-link" href="?q=<%= encodeURIComponent(q||'') %>&page=<%= page+1 %>">Next</a>
            </li>
          </ul>
        </nav>
      <% } %>
    </div>
  </div>
</section>
