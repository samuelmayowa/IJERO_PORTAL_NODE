<section class="content-header">
  <h1>My Profile</h1>
</section>

<section class="content">

  <!-- Profile status -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="alert <%= isComplete ? 'alert-success' : 'alert-warning' %>">
        <strong>Profile Status:</strong>
        <%= isComplete ? 'Complete' : 'Incomplete' %>
      </div>
    </div>
    <div class="col-md-6 text-right">
      <div class="d-inline-block" style="text-align:center;">
        <div
          style="width:80px;height:80px;border-radius:50%;overflow:hidden;border:2px solid #3c8dbc;margin-left:auto;margin-right:auto;"
        >
          <img
            src="<%= (profile && profile.photo_path) ? ('/public' + profile.photo_path) : '/public/img/avatar.png' %>"
            alt="Student photo"
            style="width:100%;height:100%;object-fit:cover;"
          />
        </div>
        <small class="text-muted d-block mt-1">Passport Photo</small>
      </div>
    </div>
  </div>

  <!-- Flash messages -->
  <% if (messages && messages.success) { %>
    <div class="alert alert-success">
      <%= messages.success %>
    </div>
  <% } %>
  <% if (messages && messages.error) { %>
    <div class="alert alert-danger">
      <%= messages.error %>
    </div>
  <% } %>

  <div class="row">
    <!-- Left: basic registration (read-only) -->
    <div class="col-md-5">
      <div class="box box-default">
        <div class="box-header with-border">
          <h3 class="box-title">Basic Information (Read Only)</h3>
        </div>
        <div class="box-body">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" class="form-control" value="<%= publicUser.first_name %>" readonly>
          </div>

          <div class="form-group">
            <label>Middle Name</label>
            <input type="text" class="form-control" value="<%= publicUser.middle_name || '' %>" readonly>
          </div>

          <div class="form-group">
            <label>Surname</label>
            <input type="text" class="form-control" value="<%= publicUser.last_name %>" readonly>
          </div>

          <div class="form-group">
            <label>Username (Matric / Portal Username)</label>
            <input type="text" class="form-control" value="<%= publicUser.username %>" readonly>
          </div>

          <div class="form-group">
            <label>Date of Birth</label>
            <input
              type="text"
              class="form-control"
              value="<%= publicUser.dob && publicUser.dob.toISOString ? publicUser.dob.toISOString().substring(0,10) : publicUser.dob %>"
              readonly>
          </div>

          <div class="form-group">
            <label>State of Origin</label>
            <input type="text" class="form-control" value="<%= publicUser.state_of_origin %>" readonly>
          </div>

          <div class="form-group">
            <label>LGA</label>
            <input type="text" class="form-control" value="<%= publicUser.lga %>" readonly>
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="text" class="form-control" value="<%= publicUser.email || '' %>" readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: editable profile (locked when COMPLETE) -->
    <div class="col-md-7">
      <form id="profileForm" method="POST" enctype="multipart/form-data" data-locked="<%= isComplete ? 'true' : 'false' %>">
        <!-- CSRF token (route-level) -->
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="box box-primary">
          <div class="box-header with-border">
            <h3 class="box-title">Complete Your Profile</h3>
          </div>

          <div class="box-body">
            <% if (isComplete) { %>
              <div class="alert alert-info">
                Your profile is <strong>COMPLETE</strong>. To make any changes, please contact your department or ICT.
              </div>
            <% } %>

            <!-- Photo upload -->
            <div class="form-group">
              <label>Upload Photo (JPG or PNG only)</label>
              <input
                type="file"
                name="photo"
                accept="image/png,image/jpeg"
                class="form-control"
                <%= isComplete ? 'disabled' : '' %>>
              <p class="help-block">Recommended: clear passport, max couple of MB.</p>
            </div>

            <!-- School / Department / Programme / Level -->
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label>School</label>
                  <select name="school_id" id="school-select" class="form-control" <%= isComplete ? 'disabled' : '' %>>
                    <option value="">-- Select School --</option>
                    <% schools.forEach(function (s) { %>
                      <option
                        value="<%= s.id %>"
                        <%= profile.school_id && profile.school_id === s.id ? 'selected' : '' %>>
                        <%= s.name %>
                      </option>
                    <% }); %>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label>Department</label>
                  <select name="department_id" id="department-select" class="form-control" <%= isComplete ? 'disabled' : '' %>>
                    <option value="">-- Select Department --</option>
                    <% departments.forEach(function (d) { %>
                      <option
                        value="<%= d.id %>"
                        data-school-id="<%= d.school_id %>"
                        <%= profile.department_id && profile.department_id === d.id ? 'selected' : '' %>>
                        <%= d.name %>
                      </option>
                    <% }); %>
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label>Programme</label>
                  <select name="programme_id" id="programme-select" class="form-control" <%= isComplete ? 'disabled' : '' %>>
                    <option value="">-- Select Programme --</option>
                    <% programmes.forEach(function (p) { %>
                      <option
                        value="<%= p.id %>"
                        data-school-id="<%= p.school_id %>"
                        data-dept-id="<%= p.department_id %>"
                        <%= profile.programme_id && profile.programme_id === p.id ? 'selected' : '' %>>
                        <%= p.name %>
                      </option>
                    <% }); %>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label>Level</label>
                  <select name="level" class="form-control" <%= isComplete ? 'disabled' : '' %>>
                    <option value="">-- Select Level --</option>
                    <% levels.forEach(function (lvl) { %>
                      <option
                        value="<%= lvl %>"
                        <%= profile.level === lvl ? 'selected' : '' %>>
                        <%= lvl %>
                      </option>
                    <% }); %>
                  </select>
                </div>
              </div>
            </div>

            <!-- Contact -->
            <div class="form-group">
              <label>Phone Number</label>
              <input
                type="text"
                name="phone"
                class="form-control"
                value="<%= profile.phone || publicUser.phone || '' %>"
                <%= isComplete ? 'readonly disabled' : '' %>>
            </div>

            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                name="email"
                class="form-control"
                value="<%= publicUser.email || '' %>"
                <%= (publicUser.email || isComplete) ? 'readonly disabled' : '' %>>
              <p class="help-block">
                <% if (!publicUser.email) { %>
                  Please provide a valid email address. This is required to complete your profile.
                <% } else { %>
                  Email was provided during registration and cannot be changed here.
                <% } %>
              </p>
            </div>

            <hr>

            <h4>Emergency Contact</h4>

            <div class="form-group">
              <label>Full Name</label>
              <input
                type="text"
                name="emergency_name"
                class="form-control"
                value="<%= profile.emergency_name || '' %>"
                <%= isComplete ? 'readonly disabled' : '' %>>
            </div>

            <div class="form-group">
              <label>Address</label>
              <textarea
                name="emergency_address"
                class="form-control"
                rows="2"
                <%= isComplete ? 'readonly disabled' : '' %>><%= profile.emergency_address || '' %></textarea>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label>Email</label>
                  <input
                    type="email"
                    name="emergency_email"
                    class="form-control"
                    value="<%= profile.emergency_email || '' %>"
                    <%= isComplete ? 'readonly disabled' : '' %>>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label>Phone</label>
                  <input
                    type="text"
                    name="emergency_phone"
                    class="form-control"
                    value="<%= profile.emergency_phone || '' %>"
                    <%= isComplete ? 'readonly disabled' : '' %>>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Relationship</label>
              <select
                name="emergency_relationship"
                class="form-control"
                <%= isComplete ? 'disabled' : '' %>>
                <option value="">-- Select Relationship --</option>
                <% ['Father','Mother','Brother','Sister','Uncle','Aunt','Guardian','Friend','Other'].forEach(function(rel){ %>
                  <option
                    value="<%= rel %>"
                    <%= profile.emergency_relationship === rel ? 'selected' : '' %>>
                    <%= rel %>
                  </option>
                <% }); %>
              </select>
            </div>
          </div>

          <div class="box-footer text-right">
            <button type="submit" class="btn btn-primary" <%= isComplete ? 'disabled' : '' %>>
              Save Profile
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Confirmation / error modal -->
<div id="saveModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h4 id="modalTitle">Confirm</h4>
    <p id="modalMessage"></p>
    <p id="modalNote" class="text-danger" style="display:none;margin-top:10px;">
      NOTE: This action cannot be undone, please double check your inputs.
    </p>
    <div class="modal-actions">
      <button id="modalYesBtn" class="btn btn-primary" type="button">YES</button>
      <button id="modalNoBtn" class="btn btn-default" type="button">NO</button>
    </div>
  </div>
</div>

<style>
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .modal-box {
    background: #fff;
    border-radius: 6px;
    padding: 20px 25px;
    width: 380px;
    text-align: center;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .modal-actions {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  #modalYesBtn, #modalNoBtn {
    min-width: 90px;
  }
</style>

<script>
  (function () {
    var schoolSelect = document.getElementById('school-select');
    var deptSelect = document.getElementById('department-select');
    var progSelect = document.getElementById('programme-select');

    function filterDepartments() {
      var schoolId = schoolSelect.value;
      Array.prototype.forEach.call(deptSelect.options, function (opt) {
        if (!opt.value) return; // skip placeholder
        var optSchool = opt.getAttribute('data-school-id');
        opt.style.display = !schoolId || optSchool === schoolId ? '' : 'none';
      });

      // clear department if not matching
      if (deptSelect.value) {
        var selectedOpt = deptSelect.querySelector('option[value="' + deptSelect.value + '"]');
        if (selectedOpt && selectedOpt.style.display === 'none') {
          deptSelect.value = '';
        }
      }

      filterProgrammes(); // keep programmes in sync
    }

    function filterProgrammes() {
      var schoolId = schoolSelect.value;
      var deptId = deptSelect.value;

      Array.prototype.forEach.call(progSelect.options, function (opt) {
        if (!opt.value) return;
        var optSchool = opt.getAttribute('data-school-id');
        var optDept = opt.getAttribute('data-dept-id');
        var matchSchool = !schoolId || optSchool === schoolId;
        var matchDept = !deptId || optDept === deptId;
        opt.style.display = matchSchool && matchDept ? '' : 'none';
      });

      if (progSelect.value) {
        var selectedOpt = progSelect.querySelector('option[value="' + progSelect.value + '"]');
        if (selectedOpt && selectedOpt.style.display === 'none') {
          progSelect.value = '';
        }
      }
    }

    if (schoolSelect && deptSelect && progSelect) {
      schoolSelect.addEventListener('change', filterDepartments);
      deptSelect.addEventListener('change', filterProgrammes);
      // initial filter on load (for existing profile)
      filterDepartments();
    }

    // ===== Modal + required fields check + YES/NO confirm =====
    const form = document.getElementById('profileForm');
    const modal = document.getElementById('saveModal');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    const note = document.getElementById('modalNote');
    const yesBtn = document.getElementById('modalYesBtn');
    const noBtn = document.getElementById('modalNoBtn');

    // If form is locked (profile COMPLETE), do nothing
    if (!form || form.dataset.locked === 'true') return;

    form.addEventListener('submit', function (e) {
      e.preventDefault(); // stop normal submit

      const requiredFields = [
        'school_id',
        'department_id',
        'programme_id',
        'level',
        'phone',
        'email',
        'emergency_name',
        'emergency_phone',
        'emergency_relationship'
      ];
      const missing = [];

      requiredFields.forEach(function (name) {
        const el = form.querySelector('[name="' + name + '"]');
        if (el && !el.value.trim()) missing.push(name);
      });

      // reset handlers every time
      yesBtn.onclick = null;
      noBtn.onclick = null;

      if (missing.length > 0) {
        title.textContent = 'Missing Information';
        message.innerHTML =
          'Please fill all required fields before saving:<br><b>' +
          missing.join(', ') +
          '</b>';
        note.style.display = 'none';
        yesBtn.style.display = 'none';
        noBtn.textContent = 'OK';
        modal.style.display = 'flex';

        noBtn.onclick = function () {
          modal.style.display = 'none';
        };
        return;
      }

      // Confirmation state
      title.textContent = 'Are you sure you want to update your profile?';
      message.textContent = '';
      note.style.display = 'block';
      yesBtn.style.display = 'inline-block';
      noBtn.textContent = 'NO';
      modal.style.display = 'flex';

      noBtn.onclick = function () {
        modal.style.display = 'none';
      };

      yesBtn.onclick = function () {
        modal.style.display = 'none';
        form.submit();
      };
    });
  })();
</script>
