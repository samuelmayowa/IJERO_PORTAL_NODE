<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Semester Result</title>
  <style>
    @page { size: A4 landscape; margin: 8mm; }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      color: #111;
      margin: 0;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      position: relative;
    }

    /* watermark (similar idea to student slip) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: url("/public/img/logo.png") no-repeat center center;
      background-size: 55%;
      opacity: 0.06;
      pointer-events: none;
      z-index: 0;
    }

    .page { position: relative; z-index: 1; }

    .header {
      display: grid;
      grid-template-columns: 90px 1fr 220px;
      gap: 10px;
      align-items: center;
      margin-bottom: 6px;
      border-bottom: 2px solid #111;
      padding-bottom: 6px;
    }
    .logo img { width: 80px; height: 80px; object-fit: contain; }
    .title { text-align: center; }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: 0.5px; }
    .title h2 { margin: 2px 0 0; font-size: 14px; font-weight: 700; }
    .title .sub { margin-top: 3px; font-size: 12px; }
    .meta {
      text-align: right;
      font-size: 11px;
      line-height: 1.3;
    }

    table.grid {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 10px;
    }
    table.grid th, table.grid td {
      border: 1px solid #111;
      padding: 3px 4px;
      vertical-align: middle;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      font-weight: 700;
      text-transform: uppercase;
      text-align: center;
    }
    .left { text-align: left; }
    .center { text-align: center; }
    .right { text-align: right; }

    /* ensure header repeats on page breaks */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    tr { page-break-inside: avoid; }

    .small { font-size: 9px; }

    .footer-grid{
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }
    .box{
      border: 1px solid #111;
      padding: 6px;
      font-size: 10px;
    }
    .box h3{
      margin: 0 0 6px;
      font-size: 11px;
      text-transform: uppercase;
      border-bottom: 1px solid #111;
      padding-bottom: 4px;
    }
    table.mini{
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }
    table.mini th, table.mini td{
      border: 1px solid #111;
      padding: 3px 4px;
      text-align: center;
    }
    .note{
      font-size: 10px;
      margin-top: 6px;
    }
  </style>
</head>

<body>
<%
  const m = meta || {};
  const s = sheet || {};
  const courses = s.courses || [];
  const detailRows = s.detailRows || [];

  const fmt2 = (n) => Number(safeNum(n)).toFixed(2);
  function safeNum(x){ const v = Number(x); return Number.isFinite(v) ? v : 0; }
%>

<div class="page">
  <div class="header">
    <div class="logo">
      <img src="/public/img/logo.png" alt="Logo"/>
    </div>

    <div class="title">
      <h1>IJERO COLLEGE</h1>
      <h2><%= (m.semester || "") %> SEMESTER RESULT SHEET</h2>
      <div class="sub">
        Session: <strong><%= m.sessionName || m.sessionId || "" %></strong>
        &nbsp; | &nbsp; Level: <strong><%= m.level || "" %></strong>
      </div>
    </div>

    <div class="meta">
      <div><strong>Printed @</strong> <%= m.printedAt || "" %></div>
      <div>Status Mode: <strong><%= (m.statusMode || "all").toUpperCase() %></strong></div>
      <div class="small">Tip: disable browser headers/footers for best match to sample.</div>
    </div>
  </div>

  <table class="grid">
    <thead>
      <tr>
        <th rowspan="2" style="width:34px">S/N</th>
        <th rowspan="2" style="width:110px">Matric No</th>
        <th rowspan="2" style="width:200px">Name</th>

        <% courses.forEach(c => { %>
          <th class="center"><%= c.code %></th>
        <% }) %>

        <th colspan="4">Current</th>
        <th colspan="4">Previous</th>
        <th colspan="4">Cumulative</th>
        <th rowspan="2" style="width:210px">Outstanding (Carry Over)</th>
        <th rowspan="2" style="width:90px">Pass/Repeat</th>
      </tr>

      <tr>
        <% courses.forEach(c => { %>
          <th class="center"><%= c.units %></th>
        <% }) %>

        <th style="width:55px">TCP</th>
        <th style="width:55px">TLU</th>
        <th style="width:60px">TUP</th>
        <th style="width:55px">GPA</th>

        <th style="width:55px">TCP</th>
        <th style="width:55px">TLU</th>
        <th style="width:60px">TUP</th>
        <th style="width:55px">GPA</th>

        <th style="width:55px">TCP</th>
        <th style="width:55px">TLU</th>
        <th style="width:60px">TUP</th>
        <th style="width:55px">GPA</th>
      </tr>
    </thead>

    <tbody>
      <% if (!detailRows.length) { %>
        <tr>
          <td class="center" colspan="<%= 3 + courses.length + 4 + 4 + 4 + 2 %>">
            No data for selected filters.
          </td>
        </tr>
      <% } %>

      <% detailRows.forEach(r => { %>
        <tr>
          <td class="center"><%= r.sn %></td>
          <td class="left"><%= r.matric %></td>
          <td class="left"><%= r.full_name %></td>

          <% (r.grades || []).forEach(g => { %>
            <td class="center"><%= g || "" %></td>
          <% }) %>

          <td class="center"><%= r.current.tcp %></td>
          <td class="center"><%= r.current.tlu %></td>
          <td class="center"><%= r.current.tup %></td>
          <td class="center"><%= fmt2(r.current.gpa) %></td>

          <td class="center"><%= r.previous.tcp %></td>
          <td class="center"><%= r.previous.tlu %></td>
          <td class="center"><%= r.previous.tup %></td>
          <td class="center"><%= fmt2(r.previous.gpa) %></td>

          <td class="center"><%= r.cumulative.tcp %></td>
          <td class="center"><%= r.cumulative.tlu %></td>
          <td class="center"><%= r.cumulative.tup %></td>
          <td class="center"><%= fmt2(r.cumulative.gpa) %></td>

          <td class="left small">
            <% if ((r.outstanding || []).length) { %>
              <% r.outstanding.forEach((o, i) => { %>
                <%= o.code %>(<%= o.units %>)<%= (i < r.outstanding.length - 1) ? ", " : "" %>
              <% }) %>
            <% } %>
          </td>
          <td class="center"><strong><%= r.passRepeat %></strong></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <div class="footer-grid">
    <div class="box">
      <h3>Grade Interpretation</h3>
      <table class="mini">
        <thead>
          <tr><th>Grade</th><th>Point</th></tr>
        </thead>
        <tbody>
          <% (s.gradeScale || []).forEach(g => { %>
            <tr>
              <td><%= g.grade %></td>
              <td><%= g.points %></td>
            </tr>
          <% }) %>
          <% if (!(s.gradeScale || []).length) { %>
            <tr><td colspan="2">No grade scale found for this selection.</td></tr>
          <% } %>
        </tbody>
      </table>
      <div class="note">
        CURRENT totals are computed using results inside the selected semester only. PREVIOUS follows your rule:
        FIRST semester = cumulative of prior sessions; SECOND semester = FIRST semester totals (same session+level).
      </div>
    </div>

    <div class="box">
      <h3>Legend</h3>
      <div class="small">
        <strong>TLU</strong> = Total Load Units attempted<br/>
        <strong>TUP</strong> = Total Unit Points = Σ(units × grade_point)<br/>
        <strong>GPA</strong> = TUP / TLU<br/>
        <strong>TCP</strong> = Total Credit Units Passed (points &gt; 0)
      </div>
    </div>
  </div>

</div>
</body>
</html>
