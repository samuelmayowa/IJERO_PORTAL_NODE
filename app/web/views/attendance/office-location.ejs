<!-- app/web/views/attendance/office-location.ejs -->
<section class="content">
  <div class="container-fluid">
    <h4 class="mb-3"><%= title %></h4>

    <% if (messages && messages.error) { %>
      <div class="alert alert-danger"><%= messages.error %></div>
    <% } %>
    <% if (messages && messages.success) { %>
      <div class="alert alert-success"><%= messages.success %></div>
    <% } %>

    <div class="row">
      <!-- Left: Form -->
      <div class="col-md-5">
        <div class="card card-success">
          <div class="card-header"><h5 class="card-title">Set Office Location</h5></div>
          <div class="card-body">
            <form action="/staff/attendance/office-location" method="POST">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">

              <div class="form-group">
                <label>School</label>
                <select class="form-control" name="school_id" id="schoolSelect" required>
                  <% (schools || []).forEach(s => { %>
                    <option value="<%= s.id %>" <%= s.id === selectedSchoolId ? 'selected' : '' %>><%= s.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="form-group">
                <label>Department</label>
                <input
                  id="departmentInput"
                  list="departmentList"
                  class="form-control"
                  name="department_name"
                  placeholder="Type or select department"
                  value="<%= (departments || []).find(d => d.id === selectedDepartmentId)?.name || '' %>"
                  required>
                <datalist id="departmentList">
                  <% (departments || []).forEach(d => { %>
                    <option value="<%= d.name %>"></option>
                  <% }) %>
                </datalist>
              </div>

              <div class="form-group">
                <label>Latitude</label>
                <input type="text" name="latitude" class="form-control"
                       placeholder="-90 to 90" value="<%= location ? location.latitude : '' %>" required>
              </div>

              <div class="form-group">
                <label>Longitude</label>
                <input type="text" name="longitude" class="form-control"
                       placeholder="-180 to 180" value="<%= location ? location.longitude : '' %>" required>
              </div>

              <button class="btn btn-success btn-block">Save Location</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: List -->
      <div class="col-md-7">
        <div class="card card-primary">
          <div class="card-header"><h5 class="card-title">Existing Office Locations</h5></div>
          <div class="card-body p-0">
            <table class="table table-striped table-bordered mb-0">
              <thead>
                <tr>
                  <th style="width:60px">#</th>
                  <th>School</th>
                  <th>Department</th>
                  <th>Latitude</th>
                  <th>Longitude</th>
                  <th style="width:140px">Action</th>
                </tr>
              </thead>
              <tbody>
                <% if (!list || list.length === 0) { %>
                  <tr><td colspan="6" class="text-center text-muted">No locations found</td></tr>
                <% } else { %>
                  <% list.forEach((row, idx) => { %>
                    <tr>
                      <td><%= (page - 1) * 10 + idx + 1 %></td>
                      <td><%= row.school_name %></td>
                      <td><%= row.department_name %></td>
                      <td><%= row.latitude %></td>
                      <td><%= row.longitude %></td>
                      <td>
                        <button class="btn btn-sm btn-info btn-edit"
                                data-id="<%= row.id %>"
                                data-lat="<%= row.latitude %>"
                                data-lon="<%= row.longitude %>">EDIT</button>
                        <button class="btn btn-sm btn-danger btn-del" data-id="<%= row.id %>">DELETE</button>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="card-footer text-center">
            <% for (let i = 1; i <= totalPages; i++) { %>
              <a href="?page=<%= i %>" class="btn btn-sm <%= i === page ? 'btn-primary' : 'btn-outline-primary' %>"><%= i %></a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Edit modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header py-2"><h5 class="modal-title">Edit Office Location</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      <div class="form-group"><label>Latitude</label><input id="editLat" class="form-control"></div>
      <div class="form-group"><label>Longitude</label><input id="editLon" class="form-control"></div>
      <small class="text-muted">Latitude: -90..90, Longitude: -180..180</small>
    </div>
    <div class="modal-footer py-2">
      <button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Cancel</button>
      <button id="btnSaveEdit" class="btn btn-success btn-sm">Save</button>
    </div>
  </div></div>
</div>

<!-- Delete modal -->
<div class="modal fade" id="delModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content bg-danger">
    <div class="modal-header py-2"><h5 class="modal-title">Confirm Delete</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>
    <div class="modal-body">Delete this office location?</div>
    <div class="modal-footer py-2">
      <button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-dark btn-sm" id="btnDoDelete">Delete</button>
    </div>
  </div></div>
</div>

<script>
function showErr(m){ $('#errMsg').text(m||'Error'); $('#errModal').modal('show'); }
function showOk(m){ $('#okMsg').text(m||'Done');  $('#okModal').modal('show'); }

// When school changes, reload department datalist
document.getElementById('schoolSelect')?.addEventListener('change', async function () {
  const schoolId = this.value;
  const dl = document.getElementById('departmentList');
  const input = document.getElementById('departmentInput');
  dl.innerHTML = '';
  input.value = '';
  const res = await fetch(`/staff/attendance/api/departments/by-school/${schoolId}`);
  const items = await res.json();
  for (const d of items) {
    const opt = document.createElement('option');
    opt.value = d.name;
    dl.appendChild(opt);
  }
});

// Edit helpers
document.querySelectorAll('.btn-edit').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    editId.value = btn.dataset.id;
    editLat.value = btn.dataset.lat;
    editLon.value = btn.dataset.lon;
    $('#editModal').modal('show');
  });
});
document.getElementById('btnSaveEdit')?.addEventListener('click', async ()=>{
  const lat = Number(editLat.value), lon = Number(editLon.value);
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return showErr('Lat/Lon must be numbers.');
  if (Math.abs(lat) > 90 || Math.abs(lon) > 180) return showErr('Latitude: -90..90, Longitude: -180..180');

  const r = await fetch('/staff/attendance/api/office-location/update', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'CSRF-Token':'<%= csrfToken %>' },
    body: JSON.stringify({ id: editId.value, latitude: lat, longitude: lon })
  });
  const j = await r.json();
  if (j.success){ $('#editModal').modal('hide'); showOk('Updated'); setTimeout(()=>location.reload(), 600); }
  else showErr(j.message || 'Failed');
});

// Delete helpers
let pendingDelete = null;
document.querySelectorAll('.btn-del').forEach(btn=>{
  btn.addEventListener('click', ()=>{ pendingDelete = btn.dataset.id; $('#delModal').modal('show'); });
});
document.getElementById('btnDoDelete')?.addEventListener('click', async ()=>{
  if(!pendingDelete) return;
  const r = await fetch(`/staff/attendance/api/office-location/${pendingDelete}/delete`, {
    method:'POST', headers:{ 'CSRF-Token':'<%= csrfToken %>' }
  });
  const j = await r.json();
  $('#delModal').modal('hide');
  if (j.success){ showOk('Deleted'); setTimeout(()=>location.reload(), 600); }
  else showErr(j.message || 'Failed');
});
</script>

<!-- Success / error modals the page JS uses -->
<div class="modal fade" id="okModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-success">
  <div class="modal-header py-2"><h5 class="modal-title">Success</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
  <div class="modal-body" id="okMsg">Done</div>
  <div class="modal-footer py-2"><button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button></div>
</div></div></div>
<div class="modal fade" id="errModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-danger">
  <div class="modal-header py-2"><h5 class="modal-title">Failed</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
  <div class="modal-body" id="errMsg">Error</div>
  <div class="modal-footer py-2"><button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button></div>
</div></div></div>
