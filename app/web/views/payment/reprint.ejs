<!-- app/web/views/payment/reprint.ejs -->
<%
const CSRF = (typeof csrfToken !== 'undefined') ? csrfToken : '';
%>
<style>
  .content,.container-fluid{padding:0!important}
  .payment-bg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:url('/public/img/bg2.jpg') center/cover no-repeat fixed;}
  .payment-card{width:520px;max-width:94vw;background:#fff;border-radius:12px;box-shadow:0 18px 60px rgba(0,0,0,.28);overflow:hidden}
  .card-head{padding:22px 24px 8px;text-align:center}
  .logo{width:78px;height:78px;object-fit:contain;margin:0 auto 8px;display:block}
  .title{font-weight:700;font-size:18px;color:#111}
  .muted{color:#6b7280;font-size:12px}
  .card-body{padding:18px 22px}
  .card-foot{padding:18px 22px 22px;border-top:1px solid #eee}
  .field{position:relative;margin-bottom:12px}
  .field .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.65}
  .field input{width:100%;height:42px;border:1px solid #d1d5db;border-radius:8px;padding:0 12px 0 40px;font-size:14px}
  .btn-primary{width:100%;height:44px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;gap:10px}
  .btn-primary .pill{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:999px;background:rgba(255,255,255,.25)}
  .below{margin-top:14px;text-align:center}
  .below a{color:#2563eb;text-decoration:none}
  .below a:hover{text-decoration:underline}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.48);display:none;align-items:center;justify-content:center;z-index:70}
  .spinner{background:#fff;border-radius:12px;padding:22px 28px;box-shadow:0 10px 40px rgba(0,0,0,.35);text-align:center}
  .spinner .big{font-weight:800}
  .spinner .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin:0 4px;background:#2563eb;animation:b 1s infinite alternate}
  .spinner .dot:nth-child(2){animation-delay:.2s}.spinner .dot:nth-child(3){animation-delay:.4s}
  @keyframes b{to{opacity:.15;transform:translateY(4px)}}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:80}
  .modal .box{background:#fff;border-radius:12px;max-width:460px;width:92vw;padding:20px 18px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
  .modal .box h3{margin:0 0 8px;font-size:18px}
  .modal .acts{display:flex;gap:10px;margin-top:12px}
  .modal .acts a{flex:1;display:inline-flex;align-items:center;justify-content:center;height:42px;border-radius:8px;font-weight:700;text-decoration:none}
  .btn-view{background:#10b981;color:#fff}
  .btn-dl{background:#2563eb;color:#fff}
</style>

<section class="payment-bg">
  <form class="payment-card" id="rpForm" method="POST" action="/payment/reprint" data-csrf="<%= CSRF %>">
    <% if (CSRF) { %><input type="hidden" name="_csrf" value="<%= CSRF %>"><% } %>

    <div class="card-head">
      <img src="/public/img/logo.png" class="logo" alt="College logo">
      <div class="title">Reprint / Validate RRR</div>
      <div class="muted">Enter your Order ID (or the Order ID tied to your RRR).</div>
    </div>

    <div class="card-body">
      <div class="field">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 3H5a2 2 0 0 0-2 2v5l9 9 7-7-9-9zM6.5 7A1.5 1.5 0 1 0 8 8.5 1.5 1.5 0 0 0 6.5 7z"/></svg>
        <input type="text" name="order_id" required placeholder="Supply your Order ID e.g. INV-20251021-1234">
      </div>
    </div>

    <div class="card-foot">
      <button class="btn-primary" type="submit">Continue <span class="pill">âžœ</span></button>
      <div class="below"><a href="/">College Portal Home Page</a></div>
    </div>
  </form>
</section>

<div class="overlay" id="overlay">
  <div class="spinner">
    <div class="big">Processing, please wait...</div>
    <div style="margin:8px 0 4px"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="box">
    <h3 id="mTitle">Request Completed</h3>
    <div id="mDesc" class="muted"></div>
    <div class="acts">
      <a id="mView" class="btn-view" target="_blank" rel="noopener">View</a>
      <a id="mDl" class="btn-dl">Download</a>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const form = $('#rpForm');
  const csrf = form.getAttribute('data-csrf') || '';
  const overlay = $('#overlay');
  const modal = $('#modal');
  const mTitle = $('#mTitle'), mDesc = $('#mDesc'), mView = $('#mView'), mDl = $('#mDl');

  function showOverlay(){ overlay.style.display='flex'; }
  function hideOverlay(){ overlay.style.display='none'; }

  function pickOrderId(data){
    return (data && (data.orderId || data.order_id || data.order || data.id || data.reference || data.ref)) || null;
  }

  function buildUrlsFrom(orderId, kind){
    if(!orderId) return {viewUrl:'#', downloadUrl:'#'};
    const base = `/payment/print/${encodeURIComponent(orderId)}?type=${encodeURIComponent(kind||'invoice')}`;
    return { viewUrl: base, downloadUrl: `${base}&dl=1` };
  }

  function showModal(kind, data){
    const orderId   = pickOrderId(data);
    const viewUrl   = data && data.viewUrl;
    const downloadUrl = data && data.downloadUrl;
    const urls = (viewUrl && downloadUrl) ? {viewUrl, downloadUrl} : buildUrlsFrom(orderId, kind);

    mTitle.textContent = 'Request Completed';
    mDesc.textContent = (kind==='receipt') ? 'Payment verified. Your receipt is ready.' : 'Your invoice is ready.';
    mView.textContent = (kind==='receipt') ? 'View Receipt' : 'View Invoice';
    mDl.textContent   = (kind==='receipt') ? 'Download Receipt' : 'Download Invoice';

    if (urls.viewUrl === '#' || urls.downloadUrl === '#') {
      alert('Order ID was not returned by the server, so we cannot open the document. Please try again.');
      modal.style.display='none';
      return;
    }

    mView.removeAttribute('download');
    mView.href = urls.viewUrl;
    mDl.href   = urls.downloadUrl;
    mDl.setAttribute('download','');

    modal.style.display='flex';
  }
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    showOverlay();

    const fd = new FormData(form);
    const params = new URLSearchParams();
    for (const [k,v] of fd.entries()) params.append(k, v);

    try{
      const r = await fetch(form.action+'?ajax=1', {
        method:'POST',
        headers:{
          'Accept':'application/json',
          'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',
          'CSRF-Token': csrf
        },
        body: params.toString()
      });

      const ct = r.headers.get('content-type')||'';
      if (!r.ok){
        const msg = ct.includes('application/json') ? (await r.json()).message : (await r.text());
        throw new Error(msg || ('HTTP '+r.status));
      }

      const data = ct.includes('application/json') ? await r.json() : {};
      hideOverlay();
      showModal(data.kind || 'invoice', data);
    }catch(err){
      hideOverlay();
      alert(err.message || 'Something went wrong.');
    }
  });
})();
</script>
