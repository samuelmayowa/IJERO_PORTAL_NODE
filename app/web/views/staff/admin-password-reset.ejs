<div class="row">
  <div class="col-md-6">
    <div class="card card-success">
      <div class="card-header"><h3 class="card-title">Password Reset</h3></div>
      <div class="card-body">
        <div class="form-group">
          <label>Role</label>
          <select id="role" class="form-control">
            <option value="">-- select --</option>
            <option>applicant</option>
            <option>student</option>
            <option>staff</option>
            <option>admin</option>
            <option>hod</option>
            <option>lecturer</option>
            <option>dean</option>
            <option>ict</option>
            <option>student union</option>
            <option>bursary</option>
            <option>registry</option>
            <option>admission officer</option>
            <option>auditor</option>
            <option>health center</option>
            <option>works</option>
            <option>library</option>
            <option>provost</option>
          </select>
        </div>

        <div class="form-group">
          <label>Search</label>
          <input
            id="search"
            type="text"
            class="form-control"
            placeholder="Search by email, name, username, or phone" />
          <small class="form-text text-muted">Type to filter users in the selected role.</small>
        </div>

        <div class="form-group">
          <label>User</label>
          <select id="user" class="form-control"></select>
        </div>

        <button id="resetBtn" class="btn btn-success">Reset to <strong>College1</strong></button>
      </div>
    </div>
  </div>
</div>

<!-- Green success modal -->
<div class="modal fade" id="okModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-success">
      <div class="modal-header py-2">
        <h5 class="modal-title">Success</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">Password Reset Successfully</div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Red failure modal -->
<div class="modal fade" id="errModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-danger">
      <div class="modal-header py-2">
        <h5 class="modal-title">Failed</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body" id="errMsg">Error</div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const roleSel = document.getElementById('role');
  const userSel = document.getElementById('user');
  const searchBox = document.getElementById('search');

  const showErr = (m)=>{ document.getElementById('errMsg').textContent = m || 'Failed'; $('#errModal').modal('show'); };

  async function loadUsers(){
    userSel.innerHTML = '';
    const role = roleSel.value || '';
    const q = searchBox.value || '';
    if(!role) return;
    const res = await fetch('/staff/api/users?role=' + encodeURIComponent(role) + '&q=' + encodeURIComponent(q));
    if(!res.ok){ showErr('Could not load users'); return; }
    const data = await res.json();
    for(const u of data){
      const opt = document.createElement('option');
      const label = [u.name, u.username, u.email, u.phone].filter(Boolean).join(' â€” ');
      opt.value = u.username;
      opt.textContent = label;
      userSel.appendChild(opt);
    }
  }

  // Debounce search typing
  let t = null;
  function debounceLoad(){
    clearTimeout(t);
    t = setTimeout(loadUsers, 250);
  }

  roleSel.addEventListener('change',  loadUsers);
  searchBox.addEventListener('input', debounceLoad);

  document.getElementById('resetBtn').addEventListener('click', async () => {
    const username = userSel.value;
    if(!username) return showErr('Select a user');
    const res = await fetch('/staff/password-reset', {
      method:'POST',
      headers: {'Content-Type':'application/json', 'CSRF-Token':'<%= csrfToken %>'},
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    if(data && data.success){ $('#okModal').modal('show'); }
    else { showErr(data.message); }
  });
});
</script>
