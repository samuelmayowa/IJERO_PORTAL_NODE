<div class="card card-success">
  <div class="card-header"><h3 class="card-title">Modify Staff</h3></div>
  <div class="card-body">
    <div class="form-row">
      <div class="form-group col-md-2"><input id="qStaffNo" class="form-control" placeholder="Staff No"></div>
      <div class="form-group col-md-2"><input id="qDept" class="form-control" placeholder="Department"></div>
      <div class="form-group col-md-2"><input id="qSchool" class="form-control" placeholder="School"></div>
      <div class="form-group col-md-3"><input id="qEmail" class="form-control" placeholder="Email"></div>
      <div class="form-group col-md-3"><input id="qName" class="form-control" placeholder="Name"></div>
    </div>
    <button id="btnSearch" class="btn btn-primary mr-2">Search</button>
    <button id="btnClear" class="btn btn-light">Clear Search Input</button>

    <div class="table-responsive mt-3">
      <table class="table table-striped" id="tbl">
        <thead><tr>
          <th>Staff No</th><th>Name</th><th>Username</th><th>Email</th>
          <th>Dept</th><th>School</th><th>Status</th><th>Action</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <small id="pageInfo" class="text-muted"></small>
      <nav><ul class="pagination mb-0" id="pager"></ul></nav>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Edit Staff</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      <div class="form-group"><label>Full Name</label><input id="editName" class="form-control"></div>
      <div class="form-group"><label>Email</label><input id="editEmail" class="form-control"></div>
      <div class="form-group"><label>Username</label><input id="editUsername" class="form-control"></div>
      <div class="form-group"><label>Staff Number</label><input id="editStaffNo" class="form-control"></div>
      <div class="form-group"><label>Department</label><input id="editDept" class="form-control"></div>
      <div class="form-group"><label>School</label><input id="editSchool" class="form-control"></div>
      <div class="form-group"><label>Phone</label><input id="editPhone" class="form-control"></div>
      <div class="form-group">
        <label>Status</label>
        <select id="editStatus" class="form-control">
          <option>ACTIVE</option>
          <option>INACTIVE</option>
          <option>SUSPENDED</option>
          <option>LEAVE OF ABSENCE</option>
          <option>SACKED</option>
          <option>TERMINATED</option>
          <option>RETIRED</option>
          <option>RESIGNED</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button id="btnSaveEdit" class="btn btn-success">Save</button>
    </div>
  </div></div>
</div>

<!-- Red delete confirm modal -->
<div class="modal fade" id="delModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content bg-danger">
    <div class="modal-header py-2"><h5 class="modal-title">Confirm Delete</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body">Delete this staff?</div>
    <div class="modal-footer py-2">
      <button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-dark btn-sm" id="btnDoDelete">Delete</button>
    </div>
  </div></div>
</div>

<!-- success / error modals -->
<div class="modal fade" id="okModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-success">
  <div class="modal-header py-2"><h5 class="modal-title">Success</h5>
    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
  <div class="modal-body" id="okMsg">Done</div>
  <div class="modal-footer py-2"><button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button></div>
</div></div></div>
<div class="modal fade" id="errModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-danger">
  <div class="modal-header py-2"><h5 class="modal-title">Failed</h5>
    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
  <div class="modal-body" id="errMsg">Error</div>
  <div class="modal-footer py-2"><button type="button" class="btn btn-light btn-sm" data-dismiss="modal">Close</button></div>
</div></div></div>

<script>
const qStaffNo = document.getElementById('qStaffNo');
const qDept = document.getElementById('qDept');
const qSchool = document.getElementById('qSchool');
const qEmail = document.getElementById('qEmail');
const qName = document.getElementById('qName');
const pageInfo = document.getElementById('pageInfo');
const pager = document.getElementById('pager');

let pendingDeleteId = null;
let currentPage = 1;
const pageSize = 10;

function showOk(m){ Modal.success(m || 'Done'); }
function showErr(m){ Modal.error(m || 'Error'); }

function qs(){
  return new URLSearchParams({
    staffNumber: qStaffNo.value, department: qDept.value, school: qSchool.value,
    email: qEmail.value, name: qName.value, page: currentPage, pageSize
  }).toString();
}

function renderPager(total){
  pager.innerHTML = '';
  const pages = Math.max(1, Math.ceil(total / pageSize));
  pageInfo.textContent = `Page ${currentPage} of ${pages} â€¢ ${total} result(s)`;
  const add = (label, page, disabled=false, active=false)=>{
    const li = document.createElement('li'); li.className = 'page-item' + (disabled?' disabled':'') + (active?' active':'');
    const a = document.createElement('a'); a.className = 'page-link'; a.href='#'; a.textContent=label;
    a.addEventListener('click', (e)=>{ e.preventDefault(); if(disabled||active) return; currentPage = page; load(); });
    li.appendChild(a); pager.appendChild(li);
  };
  add('Prev', Math.max(1, currentPage-1), currentPage===1);
  for(let p = Math.max(1,currentPage-2); p<=Math.min(pages,currentPage+2); p++) add(String(p), p, false, p===currentPage);
  add('Next', Math.min(pages, currentPage+1), currentPage===pages);
}

async function load(){
  const res = await fetch('/staff/api/staff?' + qs());
  const d = await res.json();
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  for (const u of d.items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.staffNumber||''}</td>
      <td>${u.name||''}</td>
      <td>${u.username||''}</td>
      <td>${u.email||''}</td>
      <td>${u.department||''}</td>
      <td>${u.school||''}</td>
      <td>${(u.status||'ACTIVE')}</td>
      <td>
        <button
          class="btn btn-sm btn-info btn-edit"
          data-id="${u.id}"
          data-phone="${u.phone || ''}"
          data-status="${(u.status||'ACTIVE')}"
        >EDIT</button>
        <button class="btn btn-sm btn-danger btn-del" data-id="${u.id}">DELETE</button>
      </td>`;
    tb.appendChild(tr);
  }
  // wire edit
  tb.querySelectorAll('.btn-edit').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const row = e.target.closest('tr').children;
      editId.value = btn.dataset.id;
      editStaffNo.value = row[0].textContent.trim();
      editName.value = row[1].textContent.trim();
      editUsername.value = row[2].textContent.trim();
      editEmail.value = row[3].textContent.trim();
      editDept.value = row[4].textContent.trim();
      editSchool.value = row[5].textContent.trim();
      editPhone.value = btn.dataset.phone || '';
      editStatus.value = (btn.dataset.status || row[6].textContent.trim() || 'ACTIVE').toUpperCase();
      $('#editModal').modal('show');
    });
  });
  // wire delete
  tb.querySelectorAll('.btn-del').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      pendingDeleteId = btn.dataset.id;
      $('#delModal').modal('show');
    });
  });

  renderPager(d.total);
}

document.getElementById('btnSearch').addEventListener('click', ()=>{ currentPage = 1; load(); });
document.getElementById('btnClear').addEventListener('click', ()=>{
  qStaffNo.value = qDept.value = qSchool.value = qEmail.value = qName.value = '';
  currentPage = 1; load();
});

document.getElementById('btnSaveEdit').addEventListener('click', async ()=>{
  const id = editId.value;
  const body = {
    fullName: editName.value, email: editEmail.value, username: editUsername.value,
    staffNumber: editStaffNo.value, department: editDept.value, school: editSchool.value,
    phone: editPhone.value, status: editStatus.value
  };
  const res = await fetch('/staff/api/staff/'+id, {
    method:'POST', headers:{'Content-Type':'application/json','CSRF-Token':'<%= csrfToken %>'},
    body: JSON.stringify(body)
  });
  const d = await res.json();
  if (d.success){ $('#editModal').modal('hide'); showOk('Saved'); load(); }
  else showErr(d.message||'Failed');
});

// Delete confirm
document.getElementById('btnDoDelete').addEventListener('click', async ()=>{
  if(!pendingDeleteId) return;
  const res = await fetch('/staff/api/staff/'+pendingDeleteId+'/delete', {
    method:'POST', headers:{'CSRF-Token':'<%= csrfToken %>'}
  });
  const d = await res.json();
  $('#delModal').modal('hide');
  if (d.success){ showOk('Deleted'); load(); }
  else showErr(d.message||'Failed');
});

load();
</script>
